// ChurchIligan Database Schema - ERD for dbdiagram.io
// Generated: 2025-10-16
// Last Updated: 2025-10-27
// This file contains exactly 16 core tables matching the 16 data stores from DFD
// Total Tables: 16 (Excluding DS17 Notification and DS18 User Interaction)
//
// MAPPING TO DATA STORES:
// DS1 - User Database → auth_user
// DS2 - Profile Database → accounts_profile
// DS3 - Email Verification Database → accounts_emailverification
// DS4 - User Activity Log → accounts_useractivity
// DS5 - Church Database → core_church
// DS6 - Church Verification Database → core_churchverificationrequest
// DS7 - Bookable Service Database → core_bookableservice
// DS8 - Booking Database → core_booking
// DS9 - Availability Database → core_availability
// DS10 - Post Database → core_post
// DS11 - Post Interaction Database → core_postcomment
// DS12 - Post Report Database → core_postreport
// DS13 - Donation Database → core_donation
// DS14 - Conversation Database → core_conversation
// DS15 - Message Database → core_message
// DS16 - Service Review Database → core_servicereview

// ============================================
// DS1 - USER DATABASE
// ============================================

Table auth_user {
  id bigint [pk, increment]
  username varchar(150) [unique, not null]
  email varchar(254) [unique, not null]
  password varchar(128) [not null]
  first_name varchar(150)
  last_name varchar(150)
  is_staff boolean [default: false]
  is_active boolean [default: true]
  is_superuser boolean [default: false]
  date_joined datetime [not null]
  last_login datetime
  
  Note: 'DS1 - User accounts and authentication'
}

// ============================================
// DS2 - PROFILE DATABASE
// ============================================

Table accounts_profile {
  id bigint [pk, increment]
  user_id bigint [unique, not null, ref: - auth_user.id]
  display_name varchar(150)
  phone varchar(20)
  
  // Philippine Address Structure
  region varchar(200)
  province varchar(200)
  city_municipality varchar(200)
  barangay varchar(200)
  street_address varchar(300)
  postal_code varchar(10)
  address text
  
  bio text
  date_of_birth date
  profile_image varchar(255)
  created_at datetime [not null]
  updated_at datetime [not null]
  
  Note: 'DS2 - User profiles with Philippine address structure'
}

// ============================================
// DS3 - EMAIL VERIFICATION DATABASE
// ============================================

Table accounts_emailverification {
  id bigint [pk, increment]
  email varchar(254) [not null]
  code varchar(6) [not null]
  created_at datetime [not null]
  expires_at datetime [not null]
  is_used boolean [default: false]
  attempts integer [default: 0]
  ip_address varchar(45)
  user_agent varchar(500)
  device_info varchar(200)
  
  indexes {
    (email, created_at)
  }
  
  Note: 'DS3 - Email verification codes (15 min expiry, max 5 attempts)'
}

// ============================================
// DS4 - USER ACTIVITY LOG
// ============================================

Table accounts_useractivity {
  id bigint [pk, increment]
  user_id bigint [ref: > auth_user.id]
  email varchar(254) [not null]
  activity_type varchar(30) [not null]
  success boolean [default: true]
  details text
  ip_address varchar(45) [not null]
  user_agent varchar(500) [not null]
  device_info varchar(200)
  browser_info varchar(200)
  os_info varchar(200)
  country varchar(100)
  city varchar(100)
  verification_code varchar(6)
  created_at datetime [not null]
  
  indexes {
    (user_id, created_at)
    (email, created_at)
    (ip_address, created_at)
    (activity_type, created_at)
  }
  
  Note: 'DS4 - User registration, login, and authentication activities'
}

// ============================================
// DS5 - CHURCH DATABASE
// ============================================

Table core_church {
  id bigint [pk, increment]
  name varchar(200) [not null]
  slug varchar(200) [unique, not null]
  description text [not null]
  denomination varchar(20) [not null]
  size varchar(10) [not null]
  
  // Contact Information
  email varchar(254) [not null]
  phone varchar(20) [not null]
  website varchar(200)
  
  // Philippine Address Structure
  region varchar(200)
  province varchar(200)
  city_municipality varchar(200)
  barangay varchar(200)
  street_address varchar(300)
  postal_code varchar(4)
  
  // Legacy Location Fields
  address text
  city varchar(100)
  state varchar(100)
  country varchar(100) [default: 'Philippines']
  latitude decimal(9,6)
  longitude decimal(9,6)
  
  // Leadership
  pastor_name varchar(100) [not null]
  pastor_email varchar(254)
  pastor_phone varchar(20)
  
  // Media
  logo varchar(255)
  cover_image varchar(255)
  
  // Services
  service_times text [not null]
  special_services text
  ministries text
  
  // Social Media
  facebook_url varchar(200)
  instagram_url varchar(200)
  youtube_url varchar(200)
  twitter_url varchar(200)
  
  // Payment
  paypal_email varchar(254)
  
  // Status
  owner_id bigint [not null, ref: > auth_user.id]
  is_verified boolean [default: false]
  is_active boolean [default: true]
  
  // Timestamps
  created_at datetime [not null]
  updated_at datetime [not null]
  
  // Statistics
  member_count integer [default: 0]
  follower_count integer [default: 0]
  
  Note: 'DS5 - Church/Parish organizations'
}

// ============================================
// DS6 - CHURCH VERIFICATION DATABASE
// ============================================

Table core_churchverificationrequest {
  id bigint [pk, increment]
  church_id bigint [not null, ref: > core_church.id]
  submitted_by_id bigint [not null, ref: > auth_user.id]
  status varchar(20) [not null, default: 'pending']
  notes text
  reviewed_by_id bigint [ref: > auth_user.id]
  created_at datetime [not null]
  updated_at datetime [not null]
  
  Note: 'DS6 - Church verification requests with legal documents'
}

// ============================================
// DS7 - BOOKABLE SERVICE DATABASE
// ============================================

Table core_bookableservice {
  id bigint [pk, increment]
  church_id bigint [not null, ref: > core_church.id]
  name varchar(200) [not null]
  description text
  image varchar(255)
  
  // Pricing
  price decimal(10,2)
  is_free boolean [default: true]
  payment_required boolean [default: false]
  currency varchar(3) [default: 'PHP']
  
  // Scheduling
  duration integer [not null, default: 60]
  max_bookings_per_day integer [default: 10]
  advance_booking_days integer [default: 30]
  
  // Availability
  is_active boolean [default: true]
  requires_approval boolean [default: false]
  
  // Instructions
  preparation_notes text
  cancellation_policy text
  
  // Timestamps
  created_at datetime [not null]
  updated_at datetime [not null]
  
  Note: 'DS7 - Church services that can be booked (counseling, baptism, etc.)'
}

// ============================================
// DS8 - BOOKING DATABASE
// ============================================

Table core_booking {
  id bigint [pk, increment]
  code varchar(20) [unique, not null]
  user_id bigint [not null, ref: > auth_user.id]
  church_id bigint [not null, ref: > core_church.id]
  service_id bigint [not null, ref: > core_bookableservice.id]
  date date [not null]
  start_time time
  end_time time
  notes text
  status varchar(20) [not null, default: 'requested']
  cancel_reason varchar(200)
  decline_reason varchar(200)
  
  // Payment fields (integrated in booking table)
  payment_status varchar(20) [default: 'pending']
  payment_method varchar(20)
  payment_amount decimal(10,2)
  payment_transaction_id varchar(200)
  payment_date datetime
  
  created_at datetime [not null]
  updated_at datetime [not null]
  status_changed_at datetime
  
  indexes {
    (service_id, date, status)
    (church_id, status)
    (user_id, status)
    (payment_status)
  }
  
  Note: 'DS8 - Service booking/appointment requests with payment support'
}

// ============================================
// DS9 - AVAILABILITY DATABASE
// ============================================

Table core_availability {
  id bigint [pk, increment]
  church_id bigint [not null, ref: > core_church.id]
  date date [not null]
  type varchar(20) [not null, default: 'closed_date']
  is_closed boolean [default: true]
  start_time time
  end_time time
  reason varchar(200)
  notes text
  created_at datetime [not null]
  updated_at datetime [not null]
  
  indexes {
    (church_id, date) [unique]
  }
  
  Note: 'DS9 - Church availability, closed dates, and special hours'
}

// ============================================
// DS10 - POST DATABASE
// ============================================

Table core_post {
  id bigint [pk, increment]
  church_id bigint [not null, ref: > core_church.id]
  content text [not null]
  image varchar(255)
  post_type varchar(20) [not null, default: 'general']
  
  // Event-specific fields
  event_title varchar(200)
  event_start_date datetime
  event_end_date datetime
  event_location varchar(300)
  max_participants integer
  
  // Donation
  enable_donation boolean [default: false]
  donation_goal decimal(10,2)
  
  view_count integer [default: 0]
  created_at datetime [not null]
  updated_at datetime [not null]
  is_active boolean [default: true]
  
  Note: 'DS10 - Church posts (general, photo, event, prayer request) with donation support'
}

// ============================================
// DS11 - POST INTERACTION DATABASE
// ============================================

Table core_postcomment {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > auth_user.id]
  post_id bigint [not null, ref: > core_post.id]
  parent_id bigint [ref: > core_postcomment.id]
  content text [not null]
  is_active boolean [default: true]
  created_at datetime [not null]
  updated_at datetime [not null]
  
  indexes {
    (post_id, is_active)
    (user_id, created_at)
  }
  
  Note: 'DS11 - Post comments with nested replies (represents all post interactions)'
}

// ============================================
// DS12 - POST REPORT DATABASE
// ============================================

Table core_postreport {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > auth_user.id]
  post_id bigint [not null, ref: > core_post.id]
  reason varchar(20) [not null]
  description text [not null]
  status varchar(20) [not null, default: 'pending']
  created_at datetime [not null]
  reviewed_at datetime
  reviewed_by_id bigint [ref: > auth_user.id]
  admin_notes text
  
  indexes {
    (user_id, post_id) [unique]
    (post_id, status)
    (user_id, created_at)
  }
  
  Note: 'DS12 - Users reporting inappropriate posts'
}

// ============================================
// DS13 - DONATION DATABASE
// ============================================

Table core_donation {
  id bigint [pk, increment]
  post_id bigint [not null, ref: > core_post.id]
  donor_id bigint [ref: > auth_user.id]
  
  // Donation details
  amount decimal(10,2) [not null]
  currency varchar(3) [default: 'PHP']
  message text
  is_anonymous boolean [default: false]
  
  // Payment details
  payment_method varchar(20) [not null, default: 'paypal']
  payment_status varchar(20) [not null, default: 'pending']
  
  // PayPal specific fields
  paypal_order_id varchar(255) [unique]
  paypal_payer_id varchar(255)
  paypal_payer_email varchar(254)
  paypal_transaction_id varchar(255)
  
  // Stripe specific fields
  stripe_payment_intent_id varchar(255) [unique]
  stripe_charge_id varchar(255)
  stripe_customer_id varchar(255)
  stripe_payment_method_id varchar(255)
  
  // Metadata
  created_at datetime [not null]
  updated_at datetime [not null]
  completed_at datetime
  
  indexes {
    created_at
    (post_id, payment_status)
    paypal_order_id
    paypal_transaction_id
    stripe_payment_intent_id
    stripe_charge_id
  }
  
  Note: 'DS13 - Donations made to posts with PayPal and Stripe support'
}

// ============================================
// DS14 - CONVERSATION DATABASE
// ============================================

Table core_conversation {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > auth_user.id]
  church_id bigint [not null, ref: > core_church.id]
  created_at datetime [not null]
  updated_at datetime [not null]
  
  indexes {
    (user_id, church_id) [unique]
    updated_at
  }
  
  Note: 'DS14 - Conversation between a user and a church'
}

// ============================================
// DS15 - MESSAGE DATABASE
// ============================================

Table core_message {
  id bigint [pk, increment]
  conversation_id bigint [not null, ref: > core_conversation.id]
  sender_id bigint [not null, ref: > auth_user.id]
  content text
  is_read boolean [default: false]
  created_at datetime [not null]
  
  // File attachments
  attachment varchar(255)
  attachment_type varchar(20)
  attachment_name varchar(255)
  attachment_size integer
  
  indexes {
    (conversation_id, created_at)
    (conversation_id, is_read)
  }
  
  Note: 'DS15 - Messages in a conversation with file attachment support'
}

// ============================================
// DS16 - SERVICE REVIEW DATABASE
// ============================================

Table core_servicereview {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > auth_user.id]
  service_id bigint [not null, ref: > core_bookableservice.id]
  church_id bigint [not null, ref: > core_church.id]
  booking_id bigint [ref: > core_booking.id]
  
  rating integer [not null]
  title varchar(200) [not null]
  comment text [not null]
  
  // Optional additional ratings
  staff_rating integer
  facility_rating integer
  value_rating integer
  
  // Review status
  is_active boolean [default: true]
  is_anonymous boolean [default: false]
  helpful_votes integer [default: 0]
  
  created_at datetime [not null]
  updated_at datetime [not null]
  
  indexes {
    (user_id, service_id) [unique]
    (service_id, created_at)
    (church_id, created_at)
    (rating, created_at)
    booking_id
  }
  
  Note: 'DS16 - User reviews and ratings of church services (1-5 stars)'
}

// ============================================
// EXCLUDED DATA STORES
// ============================================
// DS17 - Notification Database (excluded)
// DS18 - User Interaction Database (excluded)

// ============================================
// RELATIONSHIPS SUMMARY
// ============================================

// User Relationships:
// - One User has One Profile (1:1)
// - One User has Many Activity Logs (1:N)
// - One User owns Many Churches (1:N)
// - One User makes Many Bookings (1:N)
// - One User writes Many Reviews (1:N)
// - One User makes Many Donations (1:N)
// - One User has Many Conversations (1:N)
// - One User sends Many Messages (1:N)
// - One User writes Many Comments (1:N)
// - One User reports Many Posts (1:N)

// Church Relationships:
// - One Church has Many Bookable Services (1:N)
// - One Church has Many Availability Records (1:N)
// - One Church has Many Bookings (1:N)
// - One Church has Many Posts (1:N)
// - One Church has Many Conversations (1:N)
// - One Church has Many Verification Requests (1:N)

// Post Relationships:
// - One Post has Many Comments (1:N)
// - One Post has Many Reports (1:N)
// - One Post has Many Donations (1:N)

// Service Relationships:
// - One Service has Many Bookings (1:N)
// - One Service has Many Reviews (1:N)

// Booking Relationships:
// - One Booking can have One Review (1:1)
// - One Booking has integrated Payment fields

// Comment Relationships:
// - One Comment can have Many Replies (self-referential 1:N)

// Conversation Relationships:
// - One Conversation has Many Messages (1:N)
