{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}Create Church - ChurchConnect{% endblock %}

{% block body_class %}dashboard-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/variables/warm-sacred-earth-vars.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/themes/warm-sacred-earth-theme.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/pages/discover.css' %}?v={{ STATIC_VERSION }}">
<style>
  /* Page container aligned with Discover/Dashboard */
  .create-page { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; background: var(--bg); }
  .form-container { overflow: visible; }
  .church-form { overflow: visible; }

  /* Card sections use Discover search-section aesthetic */
  .form-section.search-section { margin-bottom: 24px; }
  .section-title { margin: 0 0 12px; color: var(--text, #1f2937); font-weight: 800; }

  /* Two-column form grid like filter-grid */
  .form-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
  .form-group-full { grid-column: 1 / -1; }

  /* Inputs styled like Discover filter controls */
  .form-label { font-weight: 700; color: var(--text); font-size: 15px; margin-bottom: 6px; display: block; }
  .form-input, .form-textarea, .form-select {
    padding: 14px 16px;
    border: 2px solid rgba(124, 58, 237, 0.1);
    border-radius: 12px;
    font-size: 15px;
    font-weight: 500;
    background: rgba(255, 255, 255, 0.9);
    color: var(--text);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  .form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: var(--brand);
    background: #fff;
    box-shadow: 0 8px 24px rgba(124, 58, 237, 0.15), 0 0 0 4px rgba(124, 58, 237, 0.1);
    transform: translateY(-2px);
  }
  select.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center; background-repeat: no-repeat; background-size: 16px; padding-right: 40px;
  }

  /* Provide extra bottom space so native selects prefer opening downward */
  .create-page { padding-bottom: 160px; }
  /* Ensure the select is not clipped and has a comfortable scroll anchor */
  #id_denomination { scroll-margin-top: 120px; position: relative; z-index: 1; }
  .form-help { color: var(--muted); font-size: 12px; margin-top: 6px; display: block; }

  /* Responsive */
  @media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
  }

  /* Searchable Dropdown Styling */
  .searchable-select {
    position: relative;
    width: 100%;
  }
  
  .searchable-select-input {
    width: 100%;
    padding: 14px 40px 14px 16px;
    border: 2px solid rgba(124, 58, 237, 0.1);
    border-radius: 12px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
  
  .searchable-select-input:focus {
    outline: none;
    border-color: var(--brand);
    background: #fff;
    box-shadow: 0 8px 24px rgba(124, 58, 237, 0.15), 0 0 0 4px rgba(124, 58, 237, 0.1);
  }
  
  .searchable-select-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
    color: #999;
  }
  
  .searchable-select-arrow {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    transition: transform 0.3s ease;
  }
  
  .searchable-select.active .searchable-select-arrow {
    transform: translateY(-50%) rotate(180deg);
  }
  
  .searchable-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid rgba(124, 58, 237, 0.1);
    border-radius: 12px;
    margin-top: 0.25rem;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    display: none;
  }
  
  .searchable-select.active .searchable-select-dropdown {
    display: block;
  }
  
  .searchable-select-option {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 15px;
  }
  
  .searchable-select-option:hover {
    background: rgba(124, 58, 237, 0.05);
  }
  
  .searchable-select-option.selected {
    background: var(--brand);
    color: white;
  }
  
  .searchable-select-option.hidden {
    display: none;
  }
  
  .searchable-select-no-results {
    padding: 1rem;
    text-align: center;
    color: #999;
    font-style: italic;
  }
  
  /* Hide the actual select element */
  .searchable-select select {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* Service Times Builder */
  .service-times-builder {
    background: rgba(255, 255, 255, 0.5);
    border: 2px solid rgba(124, 58, 237, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 12px;
  }
  
  .service-day {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
  }
  
  .service-day:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .service-day-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  
  .service-day-label {
    min-width: 100px;
    font-weight: 600;
    color: var(--text);
  }
  
  .service-time-input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid rgba(124, 58, 237, 0.2);
    border-radius: 6px;
    font-size: 14px;
  }
  
  .service-time-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
  }
  
  .add-time-btn {
    padding: 6px 12px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
  }
  
  .add-time-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  .add-time-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  .remove-time-btn {
    padding: 4px 8px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .remove-time-btn:hover {
    background: #dc2626;
  }
  
  .service-times-preview {
    margin-top: 12px;
    padding: 12px;
    background: rgba(124, 58, 237, 0.05);
    border-radius: 8px;
    font-size: 14px;
    color: var(--text);
  }
  
  .service-times-preview strong {
    display: block;
    margin-bottom: 8px;
    color: var(--brand);
  }
</style>
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}

{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
<div class="discover-page create-page warm-sacred-earth">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Create Church</h1>
      <p class="page-subtitle">Add your church to the ChurchConnect community</p>
    </div>
  </div>

  <!-- Form Container -->
  <div class="form-container">
    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message message-{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="church-form" id="church-create-form">
      {% csrf_token %}
      
      <div class="form-sections">
        <!-- Basic Information Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Basic Information</h2>
          <div class="form-grid">
            <div class="form-group form-group-full">
              <label for="{{ form.name.id_for_label }}" class="form-label">Church Name *</label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="form-error">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group form-group-full">
              <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
              {{ form.description }}
              <small class="form-help">Tell people about your church, its mission, and what makes it special</small>
              {% if form.description.errors %}
                <div class="form-error">{{ form.description.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="{{ form.denomination.id_for_label }}" class="form-label">Denomination *</label>
              {{ form.denomination }}
              {% if form.denomination.errors %}
                <div class="form-error">{{ form.denomination.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Contact Information Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Contact Information</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="{{ form.email.id_for_label }}" class="form-label">Email Address *</label>
              {{ form.email }}
              <small class="form-help">For appointment bookings and inquiries</small>
              {% if form.email.errors %}
                <div class="form-error">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number *</label>
              {{ form.phone }}
              <small class="form-help">For appointment bookings and inquiries</small>
              {% if form.phone.errors %}
                <div class="form-error">{{ form.phone.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Location Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Location</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="id_region" class="form-label">Region *</label>
              <div class="searchable-select" id="region-wrapper">
                <input type="text" class="searchable-select-input" placeholder="Select or search region..." autocomplete="off">
                <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <div class="searchable-select-dropdown"></div>
                {{ form.region }}
              </div>
              {% if form.region.errors %}
                <div class="form-error">{{ form.region.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="id_province" class="form-label">Province *</label>
              <div class="searchable-select" id="province-wrapper">
                <input type="text" class="searchable-select-input" placeholder="Select region first..." autocomplete="off" disabled>
                <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <div class="searchable-select-dropdown"></div>
                {{ form.province }}
              </div>
              {% if form.province.errors %}
                <div class="form-error">{{ form.province.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="id_city_municipality" class="form-label">City / Municipality *</label>
              <div class="searchable-select" id="city-wrapper">
                <input type="text" class="searchable-select-input" placeholder="Select province first..." autocomplete="off" disabled>
                <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <div class="searchable-select-dropdown"></div>
                {{ form.city_municipality }}
              </div>
              {% if form.city_municipality.errors %}
                <div class="form-error">{{ form.city_municipality.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="id_barangay" class="form-label">Barangay *</label>
              <div class="searchable-select" id="barangay-wrapper">
                <input type="text" class="searchable-select-input" placeholder="Select city first..." autocomplete="off" disabled>
                <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                </svg>
                <div class="searchable-select-dropdown"></div>
                {{ form.barangay }}
              </div>
              {% if form.barangay.errors %}
                <div class="form-error">{{ form.barangay.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group form-group-full">
              <label for="id_street_address" class="form-label">Street Address (House/Building No., Street Name)</label>
              {{ form.street_address }}
              <small class="form-help">Complete address needed for appointments and directions</small>
              {% if form.street_address.errors %}
                <div class="form-error">{{ form.street_address.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="id_postal_code" class="form-label">Postal Code</label>
              {{ form.postal_code }}
              <small class="form-help">4-digit postal code</small>
              {% if form.postal_code.errors %}
                <div class="form-error">{{ form.postal_code.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Visual Identity Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Visual Identity</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="{{ form.logo.id_for_label }}" class="form-label">Church Logo</label>
              {{ form.logo }}
              <small class="form-help">Upload a logo for your church (optional but recommended)</small>
              {% if form.logo.errors %}
                <div class="form-error">{{ form.logo.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="{{ form.cover_image.id_for_label }}" class="form-label">Cover Image</label>
              {{ form.cover_image }}
              <small class="form-help">Upload a cover image for your church profile (optional but recommended)</small>
              {% if form.cover_image.errors %}
                <div class="form-error">{{ form.cover_image.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Service Information Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Service Information</h2>
          <div class="form-group form-group-full">
            <label class="form-label">Service Times *</label>
            <div class="service-times-builder" id="service-times-builder">
              <!-- Days will be dynamically generated -->
            </div>
            <div class="service-times-preview" id="service-times-preview" style="display: none;">
              <strong>Preview:</strong>
              <div id="preview-text"></div>
            </div>
            <!-- Hidden textarea for form submission -->
            {{ form.service_times }}
            <small class="form-help">Select days and add service times</small>
            {% if form.service_times.errors %}
              <div class="form-error">{{ form.service_times.errors.0 }}</div>
            {% endif %}
          </div>
        </div>

        <!-- Social Media Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Social Media (Optional)</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="{{ form.facebook_url.id_for_label }}" class="form-label">Facebook Page</label>
              {{ form.facebook_url }}
              <small class="form-help">Connect your Facebook page for better engagement</small>
              {% if form.facebook_url.errors %}
                <div class="form-error">{{ form.facebook_url.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="{{ form.instagram_url.id_for_label }}" class="form-label">Instagram Profile</label>
              {{ form.instagram_url }}
              <small class="form-help">Connect your Instagram for visual content sharing</small>
              {% if form.instagram_url.errors %}
                <div class="form-error">{{ form.instagram_url.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Confirmation Section -->
        <div class="form-section search-section">
          <h2 class="section-title">Confirmation</h2>
          <div class="form-group">
            <label class="form-checkbox-label">
              {{ form.confirm_ownership }}
              <span class="checkbox-text">I confirm that I am authorized to create and manage this church listing</span>
            </label>
            {% if form.confirm_ownership.errors %}
              <div class="form-error">{{ form.confirm_ownership.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="form-actions">
        <a href="{% url 'core:discover' %}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary" id="submit-btn">
          <span class="btn-text">Create Church</span>
          <span class="btn-spinner" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('church-create-form');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnSpinner = submitBtn.querySelector('.btn-spinner');
  const denomSelect = document.getElementById('id_denomination');
  
  // Handle form submission
  form.addEventListener('submit', function(e) {
    // Show loading state
    submitBtn.disabled = true;
    btnText.textContent = 'Creating Church...';
    btnSpinner.style.display = 'inline-block';
    submitBtn.style.opacity = '0.8';
  });

  // Nudge the denomination select to center of viewport before opening
  // so the native dropdown chooses to open downward (browser heuristics)
  function ensureDropdownOpensDown() {
    try { denomSelect.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch (e) {}
  }
  if (denomSelect) {
    denomSelect.addEventListener('mousedown', ensureDropdownOpensDown);
    denomSelect.addEventListener('focus', ensureDropdownOpensDown);
    // On mobile, touchstart is helpful
    denomSelect.addEventListener('touchstart', ensureDropdownOpensDown, { passive: true });
  }
  
  // Handle image previews
  const logoInput = document.getElementById('id_logo');
  const coverInput = document.getElementById('id_cover_image');
  
  if (logoInput) {
    logoInput.addEventListener('change', function(e) {
      previewImage(e.target, 'logo-preview');
    });
  }
  
  if (coverInput) {
    coverInput.addEventListener('change', function(e) {
      previewImage(e.target, 'cover-preview');
    });
  }
  
  function previewImage(input, previewId) {
    const file = input.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        let preview = document.getElementById(previewId);
        if (!preview) {
          preview = document.createElement('div');
          preview.id = previewId;
          preview.className = 'image-preview';
          input.parentNode.appendChild(preview);
        }
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px;">`;
      };
      reader.readAsDataURL(file);
    }
  }

  // Service Times Builder
  (function() {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const builder = document.getElementById('service-times-builder');
    const hiddenTextarea = document.getElementById('id_service_times');
    const preview = document.getElementById('service-times-preview');
    const previewText = document.getElementById('preview-text');
    
    // Hide the original textarea
    if (hiddenTextarea) {
      hiddenTextarea.style.display = 'none';
    }
    
    const serviceTimes = {};
    
    // Initialize service times structure
    days.forEach(day => {
      serviceTimes[day] = {
        enabled: false,
        times: []
      };
    });
    
    // Build UI
    function buildUI() {
      builder.innerHTML = '';
      
      days.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'service-day';
        dayDiv.dataset.day = day;
        
        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'service-day-checkbox';
        checkbox.checked = serviceTimes[day].enabled;
        checkbox.addEventListener('change', () => toggleDay(day, checkbox.checked));
        
        // Label
        const label = document.createElement('span');
        label.className = 'service-day-label';
        label.textContent = day;
        
        // Times container
        const timesContainer = document.createElement('div');
        timesContainer.style.flex = '1';
        timesContainer.style.display = 'flex';
        timesContainer.style.flexDirection = 'column';
        timesContainer.style.gap = '8px';
        
        // Add time button
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'add-time-btn';
        addBtn.textContent = '+ Add Time';
        addBtn.disabled = !serviceTimes[day].enabled;
        addBtn.addEventListener('click', () => addTime(day));
        
        dayDiv.appendChild(checkbox);
        dayDiv.appendChild(label);
        dayDiv.appendChild(timesContainer);
        dayDiv.appendChild(addBtn);
        
        builder.appendChild(dayDiv);
        
        // Render existing times
        renderTimes(day);
      });
    }
    
    function toggleDay(day, enabled) {
      serviceTimes[day].enabled = enabled;
      if (!enabled) {
        serviceTimes[day].times = [];
      } else if (serviceTimes[day].times.length === 0) {
        serviceTimes[day].times.push('');
      }
      buildUI();
      updateHiddenField();
    }
    
    function addTime(day) {
      serviceTimes[day].times.push('');
      renderTimes(day);
      updateHiddenField();
    }
    
    function removeTime(day, index) {
      serviceTimes[day].times.splice(index, 1);
      renderTimes(day);
      updateHiddenField();
    }
    
    function renderTimes(day) {
      const dayDiv = builder.querySelector(`[data-day="${day}"]`);
      if (!dayDiv) return;
      
      const timesContainer = dayDiv.querySelector('div');
      timesContainer.innerHTML = '';
      
      serviceTimes[day].times.forEach((time, index) => {
        const timeRow = document.createElement('div');
        timeRow.style.display = 'flex';
        timeRow.style.gap = '8px';
        timeRow.style.alignItems = 'center';
        
        const input = document.createElement('input');
        input.type = 'time';
        input.className = 'service-time-input';
        input.value = time;
        input.disabled = !serviceTimes[day].enabled;
        input.addEventListener('change', (e) => {
          serviceTimes[day].times[index] = e.target.value;
          updateHiddenField();
        });
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-time-btn';
        removeBtn.textContent = '×';
        removeBtn.addEventListener('click', () => removeTime(day, index));
        
        timeRow.appendChild(input);
        if (serviceTimes[day].times.length > 1) {
          timeRow.appendChild(removeBtn);
        }
        
        timesContainer.appendChild(timeRow);
      });
    }
    
    function updateHiddenField() {
      const lines = [];
      
      days.forEach(day => {
        if (serviceTimes[day].enabled && serviceTimes[day].times.length > 0) {
          const times = serviceTimes[day].times
            .filter(t => t)
            .map(t => formatTime(t))
            .join(', ');
          
          if (times) {
            lines.push(`${day} ${times}`);
          }
        }
      });
      
      const result = lines.join('\\n');
      hiddenTextarea.value = result;
      
      // Update preview
      if (result) {
        previewText.innerHTML = result.replace(/\\n/g, '<br>');
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }
    
    function formatTime(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }
    
    // Initialize
    buildUI();
  })();

  // Philippine Address Cascading Dropdowns with Searchable Select
  (function() {
    const regionSelect = document.getElementById('id_region');
    const provinceSelect = document.getElementById('id_province');
    const citySelect = document.getElementById('id_city_municipality');
    const barangaySelect = document.getElementById('id_barangay');
    
    let regionCodeMap = {};
    let provinceCodeMap = {};
    let cityCodeMap = {};
    
    // Initialize searchable select component
    function initSearchableSelect(wrapperId, selectId) {
      const wrapper = document.getElementById(wrapperId);
      const input = wrapper.querySelector('.searchable-select-input');
      const dropdown = wrapper.querySelector('.searchable-select-dropdown');
      const select = document.getElementById(selectId);
      
      // Toggle dropdown on input click
      input.addEventListener('click', function() {
        if (!this.disabled) {
          wrapper.classList.toggle('active');
        }
      });
      
      // Search functionality
      input.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const options = dropdown.querySelectorAll('.searchable-select-option');
        let hasVisible = false;
        
        options.forEach(option => {
          const text = option.textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            option.classList.remove('hidden');
            hasVisible = true;
          } else {
            option.classList.add('hidden');
          }
        });
        
        // Show "no results" message
        let noResults = dropdown.querySelector('.searchable-select-no-results');
        if (!hasVisible && options.length > 0) {
          if (!noResults) {
            noResults = document.createElement('div');
            noResults.className = 'searchable-select-no-results';
            noResults.textContent = 'No results found';
            dropdown.appendChild(noResults);
          }
        } else if (noResults) {
          noResults.remove();
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
          wrapper.classList.remove('active');
        }
      });
      
      return { wrapper, input, dropdown, select };
    }
    
    // Populate dropdown options
    function populateDropdown(wrapperId, selectId, options, codeMap) {
      const wrapper = document.getElementById(wrapperId);
      const input = wrapper.querySelector('.searchable-select-input');
      const dropdown = wrapper.querySelector('.searchable-select-dropdown');
      const select = document.getElementById(selectId);
      
      // Clear existing options
      dropdown.innerHTML = '';
      select.innerHTML = '<option value="">Select...</option>';
      
      // Clear and rebuild code map
      Object.keys(codeMap).forEach(key => delete codeMap[key]);
      
      // Add options
      options.forEach(option => {
        // Store code in map immediately
        codeMap[option.name] = option.code;
        
        // Add to hidden select (for form submission)
        const selectOption = document.createElement('option');
        selectOption.value = option.name;
        selectOption.textContent = option.name;
        selectOption.dataset.code = option.code;
        select.appendChild(selectOption);
        
        // Add to visible dropdown
        const dropdownOption = document.createElement('div');
        dropdownOption.className = 'searchable-select-option';
        dropdownOption.textContent = option.name;
        dropdownOption.dataset.value = option.name;
        dropdownOption.dataset.code = option.code;
        
        dropdownOption.addEventListener('click', function() {
          // Update input value
          input.value = this.textContent;
          
          // Update hidden select
          select.value = this.dataset.value;
          
          // Close dropdown
          wrapper.classList.remove('active');
          
          // Trigger change event
          select.dispatchEvent(new Event('change'));
          
          // Update selected state
          dropdown.querySelectorAll('.searchable-select-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
        });
        
        dropdown.appendChild(dropdownOption);
      });
      
      // Enable the input
      input.disabled = false;
      input.placeholder = `Select or search...`;
      select.disabled = false;
    }
    
    // Initialize all searchable selects
    const regionComponent = initSearchableSelect('region-wrapper', 'id_region');
    const provinceComponent = initSearchableSelect('province-wrapper', 'id_province');
    const cityComponent = initSearchableSelect('city-wrapper', 'id_city_municipality');
    const barangayComponent = initSearchableSelect('barangay-wrapper', 'id_barangay');
    
    // Load regions on page load
    async function loadRegions() {
      try {
        const response = await fetch('/api/ph-regions/');
        const data = await response.json();
        
        if (data.success) {
          populateDropdown('region-wrapper', 'id_region', data.data, regionCodeMap);
        }
      } catch (error) {
        console.error('Failed to load regions:', error);
      }
    }
    
    async function loadProvinces(regionCode) {
      if (!regionCode || regionCode === 'undefined') {
        console.error('Invalid region code:', regionCode);
        return;
      }
      
      try {
        provinceComponent.input.value = 'Loading...';
        provinceComponent.input.disabled = true;
        
        const response = await fetch(`/api/ph-provinces/?region_code=${regionCode}`);
        const data = await response.json();
        
        if (data.success) {
          populateDropdown('province-wrapper', 'id_province', data.data, provinceCodeMap);
        }
      } catch (error) {
        console.error('Failed to load provinces:', error);
        provinceComponent.input.value = 'Error loading';
      }
    }
    
    async function loadCities(provinceCode) {
      if (!provinceCode || provinceCode === 'undefined') {
        console.error('Invalid province code:', provinceCode);
        return;
      }
      
      try {
        cityComponent.input.value = 'Loading...';
        cityComponent.input.disabled = true;
        
        const response = await fetch(`/api/ph-cities/?province_code=${provinceCode}`);
        const data = await response.json();
        
        if (data.success) {
          populateDropdown('city-wrapper', 'id_city_municipality', data.data, cityCodeMap);
        }
      } catch (error) {
        console.error('Failed to load cities:', error);
        cityComponent.input.value = 'Error loading';
      }
    }
    
    async function loadBarangays(cityCode) {
      if (!cityCode || cityCode === 'undefined') {
        console.error('Invalid city code:', cityCode);
        return;
      }
      
      try {
        barangayComponent.input.value = 'Loading...';
        barangayComponent.input.disabled = true;
        
        const response = await fetch(`/api/ph-barangays/?city_code=${cityCode}`);
        const data = await response.json();
        
        if (data.success) {
          populateDropdown('barangay-wrapper', 'id_barangay', data.data, {});
        }
      } catch (error) {
        console.error('Failed to load barangays:', error);
        barangayComponent.input.value = 'Error loading';
      }
    }
    
    // Event listeners for cascading
    regionSelect.addEventListener('change', function() {
      const regionCode = regionCodeMap[this.value];
      
      // Reset dependent dropdowns
      provinceComponent.input.value = '';
      provinceComponent.input.placeholder = 'Select province first...';
      provinceComponent.input.disabled = true;
      provinceComponent.dropdown.innerHTML = '';
      
      cityComponent.input.value = '';
      cityComponent.input.placeholder = 'Select city first...';
      cityComponent.input.disabled = true;
      cityComponent.dropdown.innerHTML = '';
      
      barangayComponent.input.value = '';
      barangayComponent.input.placeholder = 'Select barangay first...';
      barangayComponent.input.disabled = true;
      barangayComponent.dropdown.innerHTML = '';
      
      if (regionCode) {
        loadProvinces(regionCode);
      }
    });
    
    provinceSelect.addEventListener('change', function() {
      const provinceCode = provinceCodeMap[this.value];
      
      // Reset dependent dropdowns
      cityComponent.input.value = '';
      cityComponent.input.placeholder = 'Select city first...';
      cityComponent.input.disabled = true;
      cityComponent.dropdown.innerHTML = '';
      
      barangayComponent.input.value = '';
      barangayComponent.input.placeholder = 'Select barangay first...';
      barangayComponent.input.disabled = true;
      barangayComponent.dropdown.innerHTML = '';
      
      if (provinceCode) {
        loadCities(provinceCode);
      }
    });
    
    citySelect.addEventListener('change', function() {
      const cityCode = cityCodeMap[this.value];
      
      // Reset dependent dropdown
      barangayComponent.input.value = '';
      barangayComponent.input.placeholder = 'Select barangay first...';
      barangayComponent.input.disabled = true;
      barangayComponent.dropdown.innerHTML = '';
      
      if (cityCode) {
        loadBarangays(cityCode);
      }
    });
    
    // Postal code validation
    const postalCodeInput = document.getElementById('id_postal_code');
    if (postalCodeInput) {
      postalCodeInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
      });
    }
    
    // Initialize
    loadRegions();
  })();
});
</script>
{% endblock %}
