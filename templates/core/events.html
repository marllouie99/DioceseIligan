{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}Events - ChurchConnect{% endblock %}

{% block body_class %}page-events{% endblock %}

{% block extra_css %}
  <!-- Blue Sky Theme -->
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/donation.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/pages/church_detail.css' %}?v={{ STATIC_VERSION }}">
  <style>
    /* Force Blue Theme on Post Cards */
    .page-events .post-card {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    .page-events .post-header {
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.8) 0%, rgba(232, 244, 255, 0.8) 100%) !important;
      border-bottom: 1px solid rgba(30, 144, 255, 0.1) !important;
    }
    
    .page-events .post-content {
      background: #ffffff !important;
    }
    
    .page-events .post-actions {
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.6) 0%, rgba(232, 244, 255, 0.6) 100%) !important;
      border-top: 1px solid rgba(30, 144, 255, 0.1) !important;
    }
    
    .page-events .event-info-card {
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.9) 0%, rgba(232, 244, 255, 0.9) 100%) !important;
      border: 1px solid rgba(30, 144, 255, 0.2) !important;
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.08) !important;
    }

    .page-events .event-header {
      border-bottom: 1px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    .page-events .post-badge.event-badge {
      background: rgba(30, 144, 255, 0.1) !important;
      border: 1px solid rgba(30, 144, 255, 0.2) !important;
      color: #1E90FF !important;
    }
    
    .page-events .event-location-badge {
      background: rgba(30, 144, 255, 0.08) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
      color: #1E90FF !important;
    }
    
    .page-events .church-name-link {
      color: #1E90FF !important;
    }
    
    .page-events .church-name-link:hover {
      color: #4169E1 !important;
    }
    
    .page-events .post-action {
      color: #1E90FF !important;
    }
    
    .page-events .post-action:hover {
      background: rgba(30, 144, 255, 0.08) !important;
      color: #4169E1 !important;
    }
    
    .page-events .post-action.liked .action-text,
    .page-events .post-action.bookmarked .action-text {
      color: #1E90FF !important;
    }

    .page-events .post-actions::before {
      display: none !important;
    }

    .page-events .event-info-card .event-icon,
    .page-events .event-location-badge .location-icon {
      color: #1E90FF !important;
      stroke: #1E90FF !important;
    }

    .page-events .event-detail-item {
      border: 1px solid rgba(30, 144, 255, 0.12) !important;
    }

    .page-events .post-card:hover {
      box-shadow: 0 20px 40px rgba(30, 144, 255, 0.15) !important;
    }

    /* Fix spacing issues */
    .page-events .post-header {
      padding: 20px !important;
    }

    .page-events .post-content {
      padding: 20px !important;
    }

    .page-events .post-text {
      margin-bottom: 16px !important;
    }

    .page-events .post-badges {
      margin-bottom: 16px !important;
    }

    .page-events .event-info-card {
      margin-top: 16px !important;
      margin-bottom: 16px !important;
    }

    .page-events .post-actions {
      padding: 16px 20px !important;
    }

    /* Events page grid (avoid dashboard-layout warm theme styles) */
    .page-events .events-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
    }
    @media (max-width: 1024px) {
      .page-events .events-layout { grid-template-columns: 1fr; gap: 24px; }
    }
    @media (max-width: 768px) {
      .page-events .events-layout { gap: 20px; }
    }
    
    /* ===== BLUE SKY THEME FOR COMMENTS - OVERRIDE ALL WARM THEME ===== */
    .page-events .post-comments-section {
      background: transparent !important;
      border-top: 1px solid rgba(30, 144, 255, 0.1) !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .page-events .comments-container {
      background: transparent !important;
      padding: 16px 20px !important;
      margin: 0 !important;
    }
    
    .page-events .comment {
      display: flex !important;
      gap: 12px !important;
      padding: 12px 0 !important;
      background: transparent !important;
      border-bottom: 1px solid rgba(30, 144, 255, 0.08) !important;
      margin-bottom: 0 !important;
    }
    
    .page-events .comment:last-child {
      border-bottom: none !important;
    }
    
    .page-events .comment-reply {
      margin-left: 40px !important;
      padding-left: 12px !important;
      border-left: 2px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    .page-events .comment-avatar {
      flex-shrink: 0 !important;
    }
    
    .page-events .comment-avatar .user-avatar-small {
      width: 32px !important;
      height: 32px !important;
      border-radius: 50% !important;
      object-fit: cover !important;
      border: 2px solid rgba(30, 144, 255, 0.1) !important;
    }
    
    .page-events .comment-avatar .avatar-placeholder.small {
      width: 32px !important;
      height: 32px !important;
      font-size: 12px !important;
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.9) 0%, rgba(232, 244, 255, 0.9) 100%) !important;
      border: 2px solid rgba(30, 144, 255, 0.2) !important;
      color: #1E90FF !important;
    }
    
    .page-events .comment-content {
      flex: 1 !important;
      min-width: 0 !important;
    }
    
    .page-events .comment-author {
      font-weight: 600 !important;
      font-size: 13px !important;
      color: #1E90FF !important;
      margin-bottom: 4px !important;
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
    }
    
    .page-events .comment-text {
      font-size: 14px !important;
      color: #374151 !important;
      line-height: 1.5 !important;
      word-wrap: break-word !important;
      margin-bottom: 6px !important;
    }
    
    .page-events .comment-meta {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      font-size: 12px !important;
      color: #6b7280 !important;
    }
    
    .page-events .comment-time {
      color: #6b7280 !important;
    }
    
    .page-events .comment-reply-btn,
    .page-events .comment-report-btn {
      background: none !important;
      border: none !important;
      color: #1E90FF !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      cursor: pointer !important;
      padding: 4px 8px !important;
      border-radius: 6px !important;
      transition: all 0.2s ease !important;
      display: flex !important;
      align-items: center !important;
      gap: 4px !important;
    }
    
    .page-events .comment-reply-btn:hover,
    .page-events .comment-report-btn:hover {
      background: rgba(30, 144, 255, 0.08) !important;
      color: #4169E1 !important;
    }
    
    .page-events .comment-report-btn svg {
      width: 14px !important;
      height: 14px !important;
      stroke: currentColor !important;
    }
    
    /* Comment Form - Blue Sky Theme */
    .page-events .comment-form {
      padding: 16px 20px !important;
      background: linear-gradient(135deg, rgba(240, 248, 255, 0.4) 0%, rgba(232, 244, 255, 0.4) 100%) !important;
      border-top: 1px solid rgba(30, 144, 255, 0.1) !important;
      margin: 0 !important;
    }
    
    .page-events .comment-input-group {
      display: flex !important;
      gap: 12px !important;
      align-items: flex-start !important;
      padding: 0 !important;
    }
    
    .page-events .comment-input-wrapper {
      flex: 1 !important;
      position: relative !important;
      background: transparent !important;
    }
    
    .page-events .comment-input {
      width: 100% !important;
      min-height: 44px !important;
      padding: 12px 16px !important;
      background: rgba(255, 255, 255, 0.9) !important;
      border: 1px solid rgba(30, 144, 255, 0.2) !important;
      border-radius: 12px !important;
      font-size: 14px !important;
      color: #111827 !important;
      resize: vertical !important;
      transition: all 0.2s ease !important;
    }
    
    .page-events .comment-input:focus {
      outline: none !important;
      border-color: #1E90FF !important;
      box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1) !important;
      background: #ffffff !important;
    }
    
    .page-events .comment-input::placeholder {
      color: #6b7280 !important;
    }
    
    .page-events .comment-inline-controls {
      position: absolute !important;
      right: 8px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      display: none !important;
      gap: 4px !important;
      align-items: center !important;
    }
    
    .page-events .comment-action-btn {
      background: rgba(30, 144, 255, 0.1) !important;
      border: none !important;
      border-radius: 8px !important;
      width: 32px !important;
      height: 32px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      color: #1E90FF !important;
    }
    
    .page-events .comment-action-btn:hover {
      background: rgba(30, 144, 255, 0.2) !important;
      color: #4169E1 !important;
    }
    
    .page-events .comment-post-btn {
      background: #1E90FF !important;
      color: white !important;
    }
    
    .page-events .comment-post-btn:hover {
      background: #4169E1 !important;
    }
    
    .page-events .comment-actions {
      display: none !important;
    }
    
    .page-events .loading-comments,
    .page-events .no-comments,
    .page-events .error-comments {
      text-align: center !important;
      padding: 24px !important;
      color: #6b7280 !important;
      font-size: 14px !important;
    }
    
    .page-events .no-comments {
      color: #1E90FF !important;
    }
    
    /* Donation rank badges in comments - Keep original colors but ensure visibility */
    .page-events .donation-rank-badge {
      font-size: 10px !important;
      padding: 2px 8px !important;
      border-radius: 12px !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
    }
  </style>
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}

{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
<div class="events-page blue-sky page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Events</h1>
      <p class="page-subtitle">Upcoming events from churches you follow</p>
    </div>
  </div>

  <div class="events-layout">
    <!-- Main: 1 column event feed -->
    <div class="main-content">
      {% if total_events %}
        <div class="results-summary">
          <p class="results-count">{{ total_events }} upcoming event{{ total_events|pluralize }} from followed churches</p>
        </div>
      {% endif %}

      <div class="posts-feed">
        {% if events and events|length %}
          {% for post in events %}
            {% include 'partials/post_card.html' with post=post %}
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <h3>No upcoming events</h3>
            <p>Follow more churches to see their events here.</p>
            <a href="{% url 'core:discover' %}" class="btn btn-primary">Discover Churches</a>
          </div>
        {% endif %}
      </div>

      <!-- Pagination -->
      {% if events and events.has_other_pages %}
        <div class="pagination">
          {% if events.has_previous %}
            <a href="?page={{ events.previous_page_number }}" class="pagination-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15,18 9,12 15,6"/>
              </svg>
              Previous
            </a>
          {% endif %}
          <span class="pagination-info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Page {{ events.number }} of {{ events.paginator.num_pages }}
          </span>
          {% if events.has_next %}
            <a href="?page={{ events.next_page_number }}" class="pagination-btn">
              Next
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"/>
              </svg>
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Sidebar: other upcoming events -->
    <div class="sidebar-content">
      <div class="sidebar-section">
        <h3 class="sidebar-title">Other Upcoming Events</h3>
        <div class="upcoming-events">
          {% if other_events %}
            {% for event in other_events %}
              <div class="event-card">
                <div class="event-date-badge">
                  <div class="event-date-month">{{ event.event_start_date|date:"M" }}</div>
                  <div class="event-date-day">{{ event.event_start_date|date:"d" }}</div>
                </div>
                <div class="event-info">
                  <p class="event-title">{{ event.event_title|default:"Event" }}</p>
                  <p class="event-church">{{ event.church.name }}</p>
                  <p class="event-time">
                    <svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    {{ event.event_start_date|date:"M d, Y â€¢ g:i A" }}
                  </p>
                  {% if event.event_location %}
                  <p class="event-location">
                    <svg class="event-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                      <circle cx="12" cy="10" r="3"/>
                    </svg>
                    {{ event.event_location|truncatewords:8 }}
                  </p>
                  {% endif %}
                </div>
                <a href="{% url 'core:church_detail' event.church.slug %}?tab=posts#post-card-{{ event.id }}" class="event-view-btn">View</a>
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-events">
              <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <p class="empty-text">No other events at the moment</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Comment Report Modal -->
{% include 'partials/comment_report_modal.html' %}
{% endblock %}

{% block extra_js %}
  {# CSRF Token for AJAX requests #}
  {% csrf_token %}
  <script>
    window.csrfToken = '{{ csrf_token }}';
  </script>

  {# PayPal SDK (Orders API v2) #}
  {% if PAYPAL_CLIENT_ID %}
  <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency={{ PAYPAL_CURRENCY }}"></script>
  {% endif %}

  {# Stripe SDK #}
  {% if STRIPE_PUBLISHABLE_KEY %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    window.STRIPE_PUBLISHABLE_KEY = '{{ STRIPE_PUBLISHABLE_KEY }}';
  </script>
  {% endif %}

  {# Donation Modal and handler #}
  {% include 'partials/donation_modal.html' %}
  <script defer src="{% static 'js/components/donation.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/dashboard/dashboard-posts.js' %}?v={{ STATIC_VERSION }}"></script>
{% endblock %}
