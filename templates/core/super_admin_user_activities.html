{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}User Activities â€¢ ChurchConnect{% endblock %}

{% block body_class %}dashboard-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/variables/warm-sacred-earth-vars.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/themes/warm-sacred-earth-theme.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/pages/church_detail.css' %}?v={{ STATIC_VERSION }}">
<style>
.activity-filters {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
}

.filter-row {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.filter-group label {
  font-size: 0.875rem;
  font-weight: 500;
  color: #666;
}

.filter-group select,
.filter-group input {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.875rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: white;
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  color: #1f2937;
}

.stat-label {
  color: #666;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.activity-table {
  background: white;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.activity-table table {
  width: 100%;
  border-collapse: collapse;
}

.activity-table th {
  background: #f8f9fa;
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  border-bottom: 1px solid #e5e7eb;
}

.activity-table td {
  padding: 1rem;
  border-bottom: 1px solid #f1f3f4;
}
.activity-table .pagination { margin: 0; padding: 0.75rem 1rem; border-top: 1px solid #f1f3f4; display: flex; justify-content: center; gap: 0.5rem; background: #fff; }
.activity-table .pagination .current { background: transparent; color: #6b7280; border: 0; padding: 0; }

.status-success {
  color: #059669;
  font-weight: 500;
}

.status-failed {
  color: #dc2626;
  font-weight: 500;
}

.verification-status {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 500;
}

.verification-used {
  background: #dcfce7;
  color: #166534;
}

.verification-unused {
  background: #fef3c7;
  color: #92400e;
}

.verification-expired {
  background: #fecaca;
  color: #991b1b;
}

.device-info {
  font-size: 0.875rem;
  color: #666;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.pagination {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1rem;
}

.pagination a,
.pagination span {
  padding: 0.5rem 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  text-decoration: none;
  color: #666;
}

.pagination .current {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}
.overview-container { max-width: 100%; width: 100%; padding: 0; overflow: visible; }
.overview-section { margin-bottom: 2rem; background: #FFF9E6; border-radius: 12px; padding: 1.5rem; padding-bottom: 3.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid rgba(218,165,32,0.2); overflow: hidden; display: flow-root; position: relative; isolation: isolate; min-height: 900px; height: auto; }
.charts-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:1.5rem; margin-bottom:1.5rem; align-items:stretch; grid-auto-rows: minmax(0, auto); width:100%; }
@media (max-width:1024px){ .charts-grid{ grid-template-columns:1fr; } }
.chart-card { background:#fff; border-radius:12px; padding:1.5rem; border:1px solid #e5e7eb; box-shadow:0 1px 3px rgba(0,0,0,0.1); position:relative; }
.chart-container { position:relative; height: 260px; }
.chart-container canvas { width:100% !important; height:100% !important; display:block; }
.chart-card-full { grid-column: 1 / -1; margin-top:0; margin-bottom:0.75rem; width:100%; position:relative; clear:both; }
.chart-card-full .chart-container { height: 320px; }
@media (max-width: 520px) { .chart-card-full .chart-container { height: 280px; } }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dailyCtx = document.getElementById('dailyActivityChart');
    if (dailyCtx) {
      const labels = [
        {% for l in charts.daily_labels %}'{{ l }}'{% if not forloop.last %},{% endif %}{% endfor %}
      ];
      const counts = [
        {% for c in charts.daily_activity_counts %}{{ c }}{% if not forloop.last %},{% endif %}{% endfor %}
      ];
      new Chart(dailyCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Activities', data: counts, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.35, pointRadius: 3 }]},
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }

    const typeCtx = document.getElementById('activityTypeChart');
    if (typeCtx) {
      const labels = [
        {% for l in charts.activity_type_labels %}'{{ l }}'{% if not forloop.last %},{% endif %}{% endfor %}
      ];
      const counts = [
        {% for c in charts.activity_type_counts %}{{ c }}{% if not forloop.last %},{% endif %}{% endfor %}
      ];
      new Chart(typeCtx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: counts, backgroundColor: ['rgba(160,82,45,.8)','rgba(218,165,32,.8)','rgba(59,130,246,.8)','rgba(16,185,129,.8)','rgba(244,114,182,.8)','rgba(99,102,241,.8)','rgba(251,146,60,.8)','rgba(34,197,94,.8)','rgba(239,68,68,.8)','rgba(14,165,233,.8)','rgba(20,184,166,.8)','rgba(234,179,8,.8)'], borderWidth: 0 }]},
        options: { responsive:true, maintainAspectRatio:false, cutout:'68%', plugins:{ legend:{ position:'bottom' } } }
      });
    }

    const codesCtx = document.getElementById('codesMixChart');
    if (codesCtx) {
      const used = {{ charts.codes_mix.used|default:0 }};
      const expired = {{ charts.codes_mix.expired|default:0 }};
      const unused = {{ charts.codes_mix.unused|default:0 }};
      new Chart(codesCtx, {
        type: 'doughnut',
        data: { labels: ['Used','Expired','Pending'], datasets: [{ data: [used, expired, unused], backgroundColor: ['rgba(16,185,129,.85)','rgba(239,68,68,.85)','rgba(245,158,11,.85)'], borderWidth: 0 }]},
        options: { responsive:true, maintainAspectRatio:false, cutout:'68%', plugins:{ legend:{ position:'bottom' } } }
      });
    }

    const sectionEl = document.querySelector('.overview-section');
    function adjustOverviewHeight(){
      if (!sectionEl) return;
      const h = sectionEl.scrollHeight;
      sectionEl.style.minHeight = Math.max(h, 600) + 'px';
    }
    adjustOverviewHeight();
    window.addEventListener('resize', adjustOverviewHeight);
  });
</script>
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}

{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
<div class="super-admin-page">
  <h1 class="page-title">User Activity Registration</h1>

  <!-- Filters -->
  <div class="activity-filters">
    <form method="get" id="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label for="days">Time Period</label>
          <select name="days" id="days">
            <option value="7" {% if current_filters.days == '7' %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if current_filters.days == '30' or not current_filters.days %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if current_filters.days == '90' %}selected{% endif %}>Last 90 days</option>
            <option value="0" {% if current_filters.days == '0' %}selected{% endif %}>All time</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="activity_type">Activity Type</label>
          <select name="activity_type" id="activity_type">
            <option value="">All Activities</option>
            {% for value, label in activity_type_choices %}
              <option value="{{ value }}" {% if current_filters.activity_type == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label for="success">Status</label>
          <select name="success" id="success">
            <option value="">All Status</option>
            <option value="success" {% if current_filters.success == 'success' %}selected{% endif %}>Success</option>
            <option value="failed" {% if current_filters.success == 'failed' %}selected{% endif %}>Failed</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="search">Search</label>
          <input type="text" name="search" id="search" placeholder="Email, username, IP, code..." value="{{ current_filters.search }}">
        </div>

        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="submit" class="btn btn-primary">Filter</button>
          <a href="{% url 'core:super_admin_user_activities' %}" class="btn btn-outline">Reset</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value">{{ stats.total_activities }}</div>
      <div class="stat-label">Total Activities</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.success_count }}</div>
      <div class="stat-label">Successful</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.failed_count }}</div>
      <div class="stat-label">Failed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.total_verifications }}</div>
      <div class="stat-label">Verification Codes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.used_verifications }}</div>
      <div class="stat-label">Used Codes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.expired_verifications }}</div>
      <div class="stat-label">Expired Codes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.total_login_codes }}</div>
      <div class="stat-label">Login Codes</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.total_password_resets }}</div>
      <div class="stat-label">Password Reset Codes</div>
    </div>
  </div>

  <!-- Overview Charts -->
  <div class="overview-section">
    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">Daily Activities (Last 14 Days)</h3>
        <div class="chart-container"><canvas id="dailyActivityChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3 class="chart-title">Activity Types Distribution</h3>
        <div class="chart-container"><canvas id="activityTypeChart"></canvas></div>
      </div>
      <div class="chart-card chart-card-full">
        <h3 class="chart-title">Codes Usage Overview</h3>
        <div class="chart-container"><canvas id="codesMixChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- User Activities Table -->
  <div class="panel" data-partial-section="activities">
    <div class="panel-header">
      <div class="section-title">User Activities</div>
      <div class="panel-actions">
        <span class="badge">{{ activities|length }} of {{ stats.total_activities }} total</span>
      </div>
    </div>

    <div class="panel-body" data-partial-target>
    {% if activities %}
      <div class="activity-table">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Activity</th>
              <th>Status</th>
              <th>IP Address</th>
              <th>Device/Browser</th>
              <th>Details</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for activity in activities %}
              <tr>
                <td>
                  <div>
                    <strong>{{ activity.display_name }}</strong>
                    <br>
                    <small class="text-muted">{{ activity.email }}</small>
                  </div>
                </td>
                <td>
                  <span class="activity-type">{{ activity.get_activity_type_display }}</span>
                  {% if activity.verification_code %}
                    <br><small class="text-muted">Code: {{ activity.verification_code }}</small>
                  {% endif %}
                </td>
                <td>
                  <span class="{% if activity.success %}status-success{% else %}status-failed{% endif %}">
                    {{ activity.status_display }}
                  </span>
                </td>
                <td>
                  <code>{{ activity.ip_address }}</code>
                  {% if activity.country %}
                    <br><small class="text-muted">{{ activity.city }}{% if activity.city %}, {% endif %}{{ activity.country }}</small>
                  {% endif %}
                </td>
                <td>
                  <div class="device-info">
                    {% if activity.browser_info %}
                      <div title="{{ activity.user_agent }}">{{ activity.browser_info }}</div>
                      {% if activity.os_info %}<small class="text-muted">{{ activity.os_info }}</small>{% endif %}
                    {% else %}
                      <div title="{{ activity.user_agent }}">{{ activity.device_info|default:"Unknown" }}</div>
                    {% endif %}
                  </div>
                </td>
                <td>
                  {% if activity.details %}
                    <small class="text-muted">{{ activity.details|truncatechars:50 }}</small>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  <div>{{ activity.created_at|date:'M j, Y' }}</div>
                  <small class="text-muted">{{ activity.created_at|time:'g:i A' }}</small>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if activities.has_other_pages %}
          <div class="pagination">
            {% if activities.has_previous %}
              <a href="?{{ request.GET.urlencode }}&activities_page={{ activities.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            <span class="current">Page {{ activities.number }} of {{ activities.paginator.num_pages }}</span>
            {% if activities.has_next %}
              <a href="?{{ request.GET.urlencode }}&activities_page={{ activities.next_page_number }}">Next &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty-state">
        <p>No user activities found for the selected filters.</p>
      </div>
    {% endif %}
    </div>
  </div>

  <!-- Email Verification Codes Table -->
  <div class="panel" data-partial-section="verifications">
    <div class="panel-header">
      <div class="section-title">Email Verification Codes</div>
      <div class="panel-actions">
        <span class="badge">{{ verifications|length }} of {{ stats.total_verifications }} total</span>
      </div>
    </div>

    <div class="panel-body" data-partial-target>
    {% if verifications %}
      <div class="activity-table">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Code</th>
              <th>Status</th>
              <th>Attempts</th>
              <th>IP Address</th>
              <th>Device Info</th>
              <th>Created</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody>
            {% for verification in verifications %}
              <tr>
                <td>
                  <strong>{{ verification.email }}</strong>
                </td>
                <td>
                  <code>{{ verification.code }}</code>
                </td>
                <td>
                  {% if verification.is_used %}
                    <span class="verification-status verification-used">Used</span>
                  {% elif verification.expires_at < now %}
                    <span class="verification-status verification-expired">Expired</span>
                  {% else %}
                    <span class="verification-status verification-unused">Pending</span>
                  {% endif %}
                </td>
                <td>
                  <span class="{% if verification.attempts >= 5 %}text-danger{% elif verification.attempts >= 3 %}text-warning{% endif %}">
                    {{ verification.attempts }}/5
                  </span>
                </td>
                <td>
                  {% if verification.ip_address %}
                    <code>{{ verification.ip_address }}</code>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <div class="device-info">
                    {% if verification.device_info %}
                      <div title="{{ verification.user_agent }}">{{ verification.device_info }}</div>
                    {% elif verification.user_agent %}
                      <div title="{{ verification.user_agent }}">{{ verification.user_agent|truncatechars:30 }}</div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td>
                  <div>{{ verification.created_at|date:'M j, Y' }}</div>
                  <small class="text-muted">{{ verification.created_at|time:'g:i A' }}</small>
                </td>
                <td>
                  <div>{{ verification.expires_at|date:'M j, Y' }}</div>
                  <small class="text-muted">{{ verification.expires_at|time:'g:i A' }}</small>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if verifications.has_other_pages %}
          <div class="pagination">
            {% if verifications.has_previous %}
              <a href="?{{ request.GET.urlencode }}&verifications_page={{ verifications.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            <span class="current">Page {{ verifications.number }} of {{ verifications.paginator.num_pages }}</span>
            {% if verifications.has_next %}
              <a href="?{{ request.GET.urlencode }}&verifications_page={{ verifications.next_page_number }}">Next &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty-state">
        <p>No verification codes found for the selected filters.</p>
      </div>
    {% endif %}
    </div>
  </div>

  <!-- Login Codes Table -->
  <div class="panel" data-partial-section="login_codes">
    <div class="panel-header">
      <div class="section-title">Login Codes</div>
      <div class="panel-actions">
        <span class="badge">{{ login_codes|length }} of {{ stats.total_login_codes }} total</span>
      </div>
    </div>

    <div class="panel-body" data-partial-target>
    {% if login_codes %}
      <div class="activity-table">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Code</th>
              <th>Status</th>
              <th>Attempts</th>
              <th>IP Address</th>
              <th>Device Info</th>
              <th>Created</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody>
            {% for lc in login_codes %}
              <tr>
                <td><strong>{{ lc.email }}</strong></td>
                <td><code>{{ lc.code }}</code></td>
                <td>
                  {% if lc.is_used %}
                    <span class="verification-status verification-used">Used</span>
                  {% elif lc.expires_at < now %}
                    <span class="verification-status verification-expired">Expired</span>
                  {% else %}
                    <span class="verification-status verification-unused">Pending</span>
                  {% endif %}
                </td>
                <td><span class="{% if lc.attempts >= 5 %}text-danger{% elif lc.attempts >= 3 %}text-warning{% endif %}">{{ lc.attempts }}/5</span></td>
                <td>{% if lc.ip_address %}<code>{{ lc.ip_address }}</code>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                <td>
                  <div class="device-info">
                    {% if lc.device_info %}
                      <div title="{{ lc.user_agent }}">{{ lc.device_info }}</div>
                    {% elif lc.user_agent %}
                      <div title="{{ lc.user_agent }}">{{ lc.user_agent|truncatechars:30 }}</div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td><div>{{ lc.created_at|date:'M j, Y' }}</div><small class="text-muted">{{ lc.created_at|time:'g:i A' }}</small></td>
                <td><div>{{ lc.expires_at|date:'M j, Y' }}</div><small class="text-muted">{{ lc.expires_at|time:'g:i A' }}</small></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if login_codes.has_other_pages %}
          <div class="pagination">
            {% if login_codes.has_previous %}
              <a href="?{{ request.GET.urlencode }}&login_codes_page={{ login_codes.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            <span class="current">Page {{ login_codes.number }} of {{ login_codes.paginator.num_pages }}</span>
            {% if login_codes.has_next %}
              <a href="?{{ request.GET.urlencode }}&login_codes_page={{ login_codes.next_page_number }}">Next &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty-state">
        <p>No login codes found for the selected filters.</p>
      </div>
    {% endif %}
    </div>
  </div>

  <!-- Password Reset Codes Table -->
  <div class="panel" data-partial-section="password_resets">
    <div class="panel-header">
      <div class="section-title">Password Reset Codes</div>
      <div class="panel-actions">
        <span class="badge">{{ password_resets|length }} of {{ stats.total_password_resets }} total</span>
      </div>
    </div>

    <div class="panel-body" data-partial-target>
    {% if password_resets %}
      <div class="activity-table">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Code</th>
              <th>Status</th>
              <th>Attempts</th>
              <th>IP Address</th>
              <th>Device Info</th>
              <th>Created</th>
              <th>Expires</th>
            </tr>
          </thead>
          <tbody>
            {% for pr in password_resets %}
              <tr>
                <td><strong>{{ pr.email }}</strong></td>
                <td><code>{{ pr.code }}</code></td>
                <td>
                  {% if pr.is_used %}
                    <span class="verification-status verification-used">Used</span>
                  {% elif pr.expires_at < now %}
                    <span class="verification-status verification-expired">Expired</span>
                  {% else %}
                    <span class="verification-status verification-unused">Pending</span>
                  {% endif %}
                </td>
                <td><span class="{% if pr.attempts >= 5 %}text-danger{% elif pr.attempts >= 3 %}text-warning{% endif %}">{{ pr.attempts }}/5</span></td>
                <td>{% if pr.ip_address %}<code>{{ pr.ip_address }}</code>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                <td>
                  <div class="device-info">
                    {% if pr.device_info %}
                      <div title="{{ pr.user_agent }}">{{ pr.device_info }}</div>
                    {% elif pr.user_agent %}
                      <div title="{{ pr.user_agent }}">{{ pr.user_agent|truncatechars:30 }}</div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td><div>{{ pr.created_at|date:'M j, Y' }}</div><small class="text-muted">{{ pr.created_at|time:'g:i A' }}</small></td>
                <td><div>{{ pr.expires_at|date:'M j, Y' }}</div><small class="text-muted">{{ pr.expires_at|time:'g:i A' }}</small></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if password_resets.has_other_pages %}
          <div class="pagination">
            {% if password_resets.has_previous %}
              <a href="?{{ request.GET.urlencode }}&password_resets_page={{ password_resets.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            <span class="current">Page {{ password_resets.number }} of {{ password_resets.paginator.num_pages }}</span>
            {% if password_resets.has_next %}
              <a href="?{{ request.GET.urlencode }}&password_resets_page={{ password_resets.next_page_number }}">Next &raquo;</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty-state">
        <p>No password reset codes found for the selected filters.</p>
      </div>
    {% endif %}
    </div>
  </div>

  <!-- JavaScript for auto-submit filters -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('filter-form');
      const selects = form.querySelectorAll('select:not([name="search"])');
      
      selects.forEach(select => {
        select.addEventListener('change', function() {
          form.submit();
        });
      });

      document.addEventListener('click', function(evt) {
        const link = evt.target.closest('.panel .pagination a');
        if (!link) return;
        const panel = link.closest('.panel[data-partial-section]');
        if (!panel) return;
        evt.preventDefault();
        const section = panel.getAttribute('data-partial-section');
        const target = panel.querySelector('[data-partial-target]');
        if (!section || !target) { window.location.href = link.href; return; }
        const url = new URL(link.getAttribute('href'), window.location.href);
        url.searchParams.set('partial', section);
        fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.text())
          .then(html => {
            target.innerHTML = html;
            url.searchParams.delete('partial');
            window.history.replaceState({}, '', url.toString());
            try { panel.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (e) {}
          })
          .catch(() => { window.location.href = link.href; });
      });
    });
  </script>
</div>
{% endblock %}
