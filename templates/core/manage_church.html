{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}Manage Church - ChurchConnect{% endblock %}

{% block body_class %}page-manage-church{% endblock %}

{% block extra_css %}
  <!-- Blue Sky Theme -->
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/post_analytics_modal.css' %}?v={{ STATIC_VERSION }}">
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="{% static 'css/pages/manage-church.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}
{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
{# Church Management Page #}
<div class="manage-church-page blue-sky page-container" data-church-id="{{ church.id }}">
  {# Page Header #}
  {% include 'partials/manage/page_header.html' %}
  
  {# Verification Status Banner #}
  {% include 'partials/manage/verification_banner.html' with church=church latest_verification=latest_verification %}
  
  {# Church Preview Section #}
  {% include 'partials/manage/church_preview.html' with church=church %}
  
  {# Main Management Interface #}
  <div class="management-tabs">
    <div class="tabs-container">
      {# Tab Navigation #}
      {% include 'partials/manage/tab_navigation.html' %}
      
      <div class="tabs-content">
        {# Overview Tab #}
        {% include 'partials/manage/overview_tab.html' with church=church follower_count=follower_count analytics=analytics bookings=bookings booking_counts=booking_counts donations=donations %}

        {# Appointments Tab #}
        {% include 'partials/manage/appointments_tab.html' with bookings=bookings booking_counts=booking_counts appt_status=appt_status %}

        {# Services Tab #}
        {% include 'partials/manage/services_tab.html' with church=church %}

        {# Availability Tab #}
        {% include 'partials/manage/availability_tab.html' with church=church %}

        {# Events Tab #}
        {% include 'partials/manage/events_tab.html' with event_posts=event_posts event_posts_count=event_posts_count follower_count=follower_count church=church %}

        {# Content Tab #}
        {% include 'partials/manage/content_tab.html' with analytics=analytics follower_count=follower_count posts=posts posts_count=posts_count church=church %}

        {# Donations Tab #}
        {% include 'partials/manage/donations_tab.html' %}

        {# Transactions Tab #}
        {% include 'partials/manage/transactions_tab.html' %}

        {# Followers Tab #}
        {% include 'partials/manage/followers_tab.html' with recent_followers=recent_followers follower_count=follower_count %}

        {# Parish Admins Tab #}
        {% include 'partials/manage/admins_tab.html' with church=church %}

        {# Settings Tab #}
        {% include 'partials/manage/settings_tab.html' with church=church form=form verif_form=verif_form decline_reasons=decline_reasons %}

      </div>
    </div>
  </div>
</div>

{# Modal Dialogs #}
{% include 'partials/manage/modals.html' with church=church %}

{% endblock %}

{% block extra_js %}
{# CSRF Token for AJAX requests #}
<script>
  const csrfToken = '{{ csrf_token }}';
  window.csrfToken = '{{ csrf_token }}';
  
  // Current church ID for multi-church context
  const CURRENT_CHURCH_ID = {{ church.id }};
  window.CURRENT_CHURCH_ID = {{ church.id }};
  
  // Helper function to build URLs with church_id
  function buildChurchUrl(path, params = {}) {
    // If path already includes church_id, return as is
    if (path.includes(`/manage-church/${CURRENT_CHURCH_ID}/`)) {
      const url = new URL(path, window.location.origin);
      Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
      return url.toString();
    }
    
    // Add church_id to path
    let newPath = path;
    if (path.includes('/manage-church/') && !path.match(/\/manage-church\/\d+\//)) {
      newPath = path.replace('/manage-church/', `/manage-church/${CURRENT_CHURCH_ID}/`);
    }
    
    const url = new URL(newPath, window.location.origin);
    Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
    return url.toString();
  }
</script>
{# External Libraries #}
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{# Django URL Configuration #}
  <script>
    window.djangoUrls = {
      updateChurchLogo: "{% url 'core:update_church_logo' %}",
      updateChurchCover: "{% url 'core:update_church_cover' %}",
      createAvailability: "{% url 'core:create_availability' %}?church_id={{ church.id }}&date=0",
      manageServiceImages: "{% url 'core:manage_service_images' 0 %}",
      serviceGallery: "{% url 'core:service_gallery' 0 %}",
      requestVerification: "{% url 'core:request_verification' %}",
      createDeclineReason: "{% url 'core:create_decline_reason' %}"
    };
    // Backwards compatibility for existing JS that expects globals
    window.manageServiceImagesUrl = window.djangoUrls.manageServiceImages;
    window.serviceGalleryUrl = window.djangoUrls.serviceGallery;
    // Legacy URL variable for backward compatibility
    window.createDeclineReasonUrl = "{% url 'core:create_decline_reason' %}";
  </script>

{# Core Modules #}
<script defer src="{% static 'js/core/tabs.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/forms.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/image-cropper.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/calendar.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/core/settings.js' %}?v={{ STATIC_VERSION }}"></script>

{# Application Modules #}
<script defer src="{% static 'js/app/manage_church_new.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/manage/post-management.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/dashboard/dashboard-posts.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/expandable-posts.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/post-view-tracker.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/components/post_analytics_modal.js' %}?v={{ STATIC_VERSION }}&t=20251031"></script>
<script defer src="{% static 'js/followers.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/sticky-tabs.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/settings-navigation.js' %}?v={{ STATIC_VERSION }}"></script>
<script defer src="{% static 'js/settings-section-edit.js' %}?v={{ STATIC_VERSION }}"></script>
{% endblock %}
