{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}{{ page_title }} - ChurchConnect{% endblock %}

{% block body_class %}page-appointments{% endblock %}

{% block extra_css %}
  <!-- Blue Sky Theme -->
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="{% static 'css/pages/appointments.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}

{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{% block content %}
<div class="appointments-page blue-sky page-container">
  <div class="page-header">
    <h1 style="margin:0;">My Appointments</h1>
    <p class="text-muted">Track your appointment requests. Click on a status to filter.</p>
  </div>

  <!-- Status Filter Pills -->

  <div class="status-pills">
    <a class="status-pill {% if status_filter == 'all' %}active{% endif %}" href="{% url 'core:appointments' %}?status=all">All <span class="count">{{ counts.all }}</span></a>
    <a class="status-pill {% if status_filter == 'requested' %}active{% endif %}" href="{% url 'core:appointments' %}?status=requested">Pending <span class="count">{{ counts.requested }}</span></a>
    <a class="status-pill {% if status_filter == 'reviewed' %}active{% endif %}" href="{% url 'core:appointments' %}?status=reviewed">Reviewed <span class="count">{{ counts.reviewed }}</span></a>
    <a class="status-pill {% if status_filter == 'approved' %}active{% endif %}" href="{% url 'core:appointments' %}?status=approved">Approved <span class="count">{{ counts.approved }}</span></a>
    <a class="status-pill {% if status_filter == 'completed' %}active{% endif %}" href="{% url 'core:appointments' %}?status=completed">Completed <span class="count">{{ counts.completed }}</span></a>
  </div>

  {% if bookings %}
    <div class="booking-list">
      {% for b in bookings %}
        <div class="booking-card">
          <!-- Left Section: Service Info -->
          <div class="booking-card-left">
            <div class="booking-header-section">
              <h3 class="booking-service-name">{{ b.service.name }}</h3>
              <span class="badge badge-{{ b.status }}">{{ b.get_status_display }}</span>
            </div>
            
            <div class="booking-church-info">
              <i data-feather="map-pin"></i>
              <span>{{ b.church.name }}</span>
            </div>
            
            <div class="booking-meta-row">
              <div class="booking-meta-item">
                <i data-feather="hash"></i>
                <span class="meta-label">ID:</span>
                <span class="meta-value">{{ b.code }}</span>
              </div>
              <div class="booking-meta-item">
                <i data-feather="calendar"></i>
                <span class="meta-label">Requested:</span>
                <span class="meta-value">{{ b.created_at|date:'M j, Y' }}</span>
              </div>
            </div>
            
            {% if b.status == 'declined' and b.decline_reason %}
              <div class="booking-decline-reason">
                <i data-feather="alert-circle"></i>
                <span>{{ b.decline_reason }}</span>
              </div>
            {% endif %}
          </div>
          
          <!-- Center Section: Date & Time -->
          <div class="booking-card-center">
            <div class="booking-datetime-card">
              <div class="datetime-item">
                <i data-feather="calendar"></i>
                <div class="datetime-content">
                  <span class="datetime-label">Date</span>
                  <span class="datetime-value">{{ b.date|date:'M j, Y' }}</span>
                </div>
              </div>
              <div class="datetime-divider"></div>
              <div class="datetime-item">
                <i data-feather="clock"></i>
                <div class="datetime-content">
                  <span class="datetime-label">Time</span>
                  <span class="datetime-value">{% if b.start_time %}{{ b.start_time|time:'g:i A' }}{% if b.end_time %} - {{ b.end_time|time:'g:i A' }}{% endif %}{% else %}Not set{% endif %}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Section: Actions -->
          <div class="booking-card-right">
            {% if b.church.slug %}
              <a href="{% url 'core:church_detail' b.church.slug %}" class="booking-icon-btn" title="View Church">
                <i data-feather="eye"></i>
              </a>
            {% endif %}
            
            {% if b.status == 'reviewed' or b.status == 'approved' %}
              <a href="{% url 'core:booking_invoice' b.id %}" class="booking-icon-btn" title="Print Invoice">
                <i data-feather="printer"></i>
              </a>
            {% elif b.status == 'completed' %}
              {% if b.user_has_reviewed %}
                <a href="{% url 'core:service_reviews' b.service.id %}" class="booking-icon-btn" title="Check Review">
                  <i data-feather="check-circle"></i>
                </a>
              {% else %}
                <button class="booking-icon-btn" onclick="openReviewModal({{ b.service.id }}, '{{ b.service.name|escapejs }}', '{{ b.church.name|escapejs }}', {{ b.id }})" title="Rate & Review">
                  <i data-feather="star"></i>
                </button>
              {% endif %}
              <a href="{% url 'core:booking_invoice' b.id %}" class="booking-icon-btn" title="View Invoice">
                <i data-feather="file-text"></i>
              </a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <h3>No appointments yet</h3>
      <p>Request an appointment from a church page to get started.</p>
    </div>
  {% endif %}
</div>

<!-- Review Modal -->
<div id="reviewModal" class="review-modal-overlay" style="display: none;">
  <div class="review-modal">
    <div class="review-modal-header">
      <h3>Rate & Review Service</h3>
      <button class="modal-close" onclick="closeReviewModal()">&times;</button>
    </div>
    
    <div class="review-modal-content">
      <div class="service-info-display">
        <h4 id="modal-service-name"></h4>
        <p id="modal-church-name"></p>
      </div>

      <form id="reviewForm" class="review-form-modal">
        {% csrf_token %}
        
        <div class="form-group">
          <label>Overall Rating *</label>
          <div class="star-rating-modal" data-rating="0">
            {% for i in "12345" %}
              <i class="star" data-value="{{ i }}">â˜…</i>
            {% endfor %}
          </div>
          <input type="hidden" name="rating" id="modal-rating" required>
        </div>
        
        <div class="form-group">
          <label for="modal-title">Review Title *</label>
          <input type="text" name="title" id="modal-title" class="form-control" required placeholder="Summary of your experience">
        </div>
        
        <div class="form-group">
          <label for="modal-comment">Review Comment *</label>
          <textarea name="comment" id="modal-comment" class="form-control" rows="4" required placeholder="Share your detailed experience..."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeReviewModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- External JavaScript -->
<script>
  // Django template variables for JavaScript
  window.djangoUrls = {
    createReviewUrl: "{% url 'core:create_service_review' service_id=0 %}"
  };
</script>
<script src="{% static 'js/my_appointments.js' %}"></script>

{% endblock %}
