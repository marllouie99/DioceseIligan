{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}ChurchConnect{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/app.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/chat-widget.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/chat-typing-animation.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/parish_hover_card.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/post_images_grid.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/multi_image_upload.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/post_image_lightbox.css' %}?v={{ STATIC_VERSION }}">
  {% block extra_css %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %} {% if profile_essentials_incomplete %}needs-essentials{% endif %}" data-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  
  <div class="app-shell">
    <aside class="sidebar" id="sidebar">
      {% block sidebar %}{% endblock %}
    </aside>
    <div class="main">
      <header class="topbar {% if user.is_superuser and is_admin_mode %}admin-mode{% endif %}">
        {% block topbar %}{% endblock %}
      </header>
      <main class="content">
        {% if messages %}
        <div class="flash-messages">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Chat Widget (hidden in super admin mode) -->
  {% if user.is_authenticated and not is_admin_mode %}
  {% include 'partials/chat_widget.html' %}
  {% endif %}

  <!-- Parish Hover Card -->
  {% include 'partials/parish_hover_card.html' %}

  <!-- Load utility modules first -->
  <script defer src="{% static 'js/core/utils.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/core/navigation.js' %}?v={{ STATIC_VERSION }}"></script>
  <!-- <script defer src="{% static 'js/core/search.js' %}?v={{ STATIC_VERSION }}"></script> -->
  <script defer src="{% static 'js/core/toasts.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/topbar-search.js' %}?v={{ STATIC_VERSION }}"></script>
  <!-- Load profile modules -->
  {% block legacy_profile_js %}
  <script defer src="{% static 'js/profile/profile.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/profile/profile-modal.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/profile/profile-form.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/profile/profile-avatar.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/profile/profile-display.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/profile/profile-utils.js' %}?v={{ STATIC_VERSION }}"></script>
  {% endblock %}
  <!-- Load notification modules -->
  <script defer src="{% static 'js/notifications/notification-dropdown.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/notifications/notification-api.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/notifications/notification-badge.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/notifications/notification-events.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/notifications/notification-utils.js' %}?v={{ STATIC_VERSION }}"></script>
  <!-- Load main applications -->
  <script defer src="{% static 'js/app/app_new.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/app/notifications_new.js' %}?v={{ STATIC_VERSION }}"></script>
  {% block profile_app_js %}
  <script defer src="{% static 'js/app/profile_new.js' %}?v={{ STATIC_VERSION }}"></script>
  {% endblock %}
  <!-- Load dashboard modules -->
  <script defer src="{% static 'js/dashboard/dashboard-posts.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/post-bookmark.js' %}?v={{ STATIC_VERSION }}"></script>
  <script defer src="{% static 'js/components/parish-hover-card.js' %}?v={{ STATIC_VERSION }}"></script>
  
  <!-- Load chat widget (hidden in super admin mode) -->
  {% if user.is_authenticated and not is_admin_mode %}
  <script defer src="{% static 'js/components/chat-widget.js' %}?v={{ STATIC_VERSION }}"></script>
  {% endif %}
  
  <!-- Mobile Menu Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      
      if (mobileMenuToggle && sidebar && sidebarOverlay) {
        // Toggle sidebar on mobile menu button click
        mobileMenuToggle.addEventListener('click', function() {
          sidebar.classList.toggle('mobile-open');
          sidebarOverlay.classList.toggle('active');
          document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        });
        
        // Close sidebar when overlay is clicked
        sidebarOverlay.addEventListener('click', function() {
          sidebar.classList.remove('mobile-open');
          sidebarOverlay.classList.remove('active');
          document.body.style.overflow = '';
        });
        
        // Close sidebar on window resize to desktop size
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            sidebar.classList.remove('mobile-open');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
          }
        });
      }
    });
  </script>
  
  <!-- Collapsible Navigation Groups Script -->
  <script>
    (function() {
      'use strict';
      
      // Wait for DOM to be fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNavGroups);
      } else {
        initNavGroups();
      }
      
      function initNavGroups() {
        const navGroupToggles = document.querySelectorAll('.nav-group-toggle');
        
        if (!navGroupToggles.length) {
          return; // No nav groups found, exit gracefully
        }
        
        navGroupToggles.forEach(toggle => {
          // Add click handler
          toggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const groupName = this.dataset.group;
            if (!groupName) return;
            
            const submenu = document.querySelector(`[data-submenu="${groupName}"]`);
            
            // Toggle expanded state
            this.classList.toggle('expanded');
            
            // Toggle submenu visibility
            if (submenu) {
              submenu.classList.toggle('show');
            }
            
            // Save state to localStorage
            const isExpanded = this.classList.contains('expanded');
            try {
              localStorage.setItem(`nav-group-${groupName}`, isExpanded ? 'expanded' : 'collapsed');
            } catch (err) {
              console.warn('localStorage not available:', err);
            }
          });
          
          // Restore state from localStorage
          const groupName = toggle.dataset.group;
          if (!groupName) return;
          
          try {
            const savedState = localStorage.getItem(`nav-group-${groupName}`);
            const submenu = document.querySelector(`[data-submenu="${groupName}"]`);
            
            if (savedState === 'expanded' && !toggle.classList.contains('expanded')) {
              toggle.classList.add('expanded');
              if (submenu) {
                submenu.classList.add('show');
              }
            } else if (savedState === 'collapsed' && toggle.classList.contains('expanded')) {
              toggle.classList.remove('expanded');
              if (submenu) {
                submenu.classList.remove('show');
              }
            }
          } catch (err) {
            console.warn('localStorage not available:', err);
          }
        });
      }
    })();
  </script>
  
  <!-- Global Post Menu Delegated Handler (toggle + outside close) -->
  <script>
    (function() {
      if (window.postMenuDelegatedHandlerAttached) return;
      window.postMenuDelegatedHandlerAttached = true;

      function handle(e) {
        const target = e.target;
        const btn = target.closest('.post-menu-btn');
        const insideDropdown = target.closest('.post-menu-dropdown');
        const insideModal = target.closest('.post-modal');

        // Toggle when clicking the 3-dots button
        if (btn) {
          e.preventDefault();

          const card = btn.closest('.post-card');
          if (!card) return;
          const dropdown = card.querySelector('.post-menu-dropdown');
          if (!dropdown) return;

          const willOpen = !dropdown.classList.contains('show');

          // Close all others
          document.querySelectorAll('.post-menu-dropdown.show').forEach(dd => {
            dd.classList.remove('show');
            const c = dd.closest('.post-card');
            if (c) c.classList.remove('dropdown-open');
            dd.style && dd.style.removeProperty && dd.style.removeProperty('display');
          });

          // Open current if intended
          if (willOpen) {
            dropdown.classList.add('show');
            dropdown.style && dropdown.style.removeProperty && dropdown.style.removeProperty('display');
            card.classList.add('dropdown-open');
          }
          return;
        }

        // If clicking a menu item, close its dropdown and let its own handler run
        if (target.closest('.menu-item')) {
          const dd = target.closest('.post-menu-dropdown');
          if (dd) {
            dd.classList.remove('show');
            const c = dd.closest('.post-card');
            if (c) c.classList.remove('dropdown-open');
          }
          return;
        }

        // Outside click: close all (ignore clicks inside dropdown or modals)
        if (!insideDropdown && !insideModal) {
          document.querySelectorAll('.post-menu-dropdown.show').forEach(dd => {
            dd.classList.remove('show');
            const c = dd.closest('.post-card');
            if (c) c.classList.remove('dropdown-open');
            dd.style && dd.style.removeProperty && dd.style.removeProperty('display');
          });
        }
      }

      // Single click handler
      document.addEventListener('click', handle, false);
    })();
  </script>
  
  <!-- Post Image Lightbox -->
  <div id="postImageLightbox" class="post-image-lightbox">
    <button class="lightbox-close" onclick="closePostImageLightbox()">&times;</button>
    <button class="lightbox-nav lightbox-prev" onclick="navigatePostImage(-1)">‹</button>
    <button class="lightbox-nav lightbox-next" onclick="navigatePostImage(1)">›</button>
    <div class="lightbox-content">
      <img id="lightboxImage" class="lightbox-image" src="" alt="Post Image">
    </div>
    <div class="lightbox-counter">
      <span id="lightboxCounter">1 / 1</span>
    </div>
  </div>
  
  <!-- Post Image Lightbox Script -->
  <script>
    let currentLightboxImages = [];
    let currentLightboxIndex = 0;
    
    function openPostImageLightbox(images, startIndex = 0) {
      currentLightboxImages = images;
      currentLightboxIndex = startIndex;
      
      const lightbox = document.getElementById('postImageLightbox');
      const lightboxImage = document.getElementById('lightboxImage');
      const counter = document.getElementById('lightboxCounter');
      const prevBtn = document.querySelector('.lightbox-prev');
      const nextBtn = document.querySelector('.lightbox-next');
      
      lightboxImage.src = images[startIndex];
      counter.textContent = `${startIndex + 1} / ${images.length}`;
      
      // Update nav buttons state
      prevBtn.classList.toggle('disabled', startIndex === 0);
      nextBtn.classList.toggle('disabled', startIndex === images.length - 1);
      
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closePostImageLightbox() {
      const lightbox = document.getElementById('postImageLightbox');
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
      currentLightboxImages = [];
      currentLightboxIndex = 0;
    }
    
    function navigatePostImage(direction) {
      const newIndex = currentLightboxIndex + direction;
      
      if (newIndex < 0 || newIndex >= currentLightboxImages.length) {
        return;
      }
      
      currentLightboxIndex = newIndex;
      const lightboxImage = document.getElementById('lightboxImage');
      const counter = document.getElementById('lightboxCounter');
      const prevBtn = document.querySelector('.lightbox-prev');
      const nextBtn = document.querySelector('.lightbox-next');
      
      lightboxImage.src = currentLightboxImages[currentLightboxIndex];
      counter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;
      
      // Update nav buttons state
      prevBtn.classList.toggle('disabled', currentLightboxIndex === 0);
      nextBtn.classList.toggle('disabled', currentLightboxIndex === currentLightboxImages.length - 1);
    }
    
    // Close lightbox on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closePostImageLightbox();
      } else if (e.key === 'ArrowLeft') {
        navigatePostImage(-1);
      } else if (e.key === 'ArrowRight') {
        navigatePostImage(1);
      }
    });
    
    // Close lightbox when clicking outside image
    document.addEventListener('click', function(e) {
      const lightbox = document.getElementById('postImageLightbox');
      if (e.target === lightbox) {
        closePostImageLightbox();
      }
    });
    
    // Initialize post image click handlers
    document.addEventListener('DOMContentLoaded', function() {
      // Use event delegation for dynamically loaded posts
      document.body.addEventListener('click', function(e) {
        const img = e.target.closest('.post-images-grid img');
        if (img) {
          e.preventDefault();
          
          const grid = img.closest('.post-images-grid');
          let imageUrls, clickedIndex;
          
          // Check if grid has data-all-images attribute (for posts with 5+ images)
          const allImagesData = grid.getAttribute('data-all-images');
          
          if (allImagesData) {
            // Use all images from data attribute
            imageUrls = allImagesData.split('|||');
            
            // Find which image was clicked by matching the src
            const clickedSrc = img.src;
            clickedIndex = imageUrls.findIndex(url => {
              // Compare the full URL or just the path
              return clickedSrc.includes(url) || url.includes(clickedSrc.split('/').pop());
            });
            
            // If not found (shouldn't happen), default to 0
            if (clickedIndex === -1) clickedIndex = 0;
          } else {
            // Use rendered images (for posts with <= 5 images)
            const allImages = Array.from(grid.querySelectorAll('img'));
            imageUrls = allImages.map(imgEl => imgEl.src);
            clickedIndex = allImages.indexOf(img);
          }
          
          openPostImageLightbox(imageUrls, clickedIndex);
        }
      });
    });
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>
