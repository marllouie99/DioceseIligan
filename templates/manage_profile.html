{% extends 'layouts/app_base.html' %}
{% load static %}

{% block title %}My Profile - ChurchConnect{% endblock %}

{% block extra_css %}
  <!-- Blue Sky Theme -->
  <link rel="stylesheet" href="{% static 'css/variables/blue-sky-vars.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/themes/blue-sky-theme.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'css/components/forms.css' %}?v={{ STATIC_VERSION }}">
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="{% static 'css/pages/profile.css' %}?v={{ STATIC_VERSION }}">
  <style>
    /* Searchable Dropdown Styling */
    .searchable-select {
      position: relative;
      width: 100%;
    }
    
    .searchable-select-input {
      width: 100%;
      padding: 0.75rem 2.5rem 0.75rem 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      background: white;
      transition: all 0.3s ease;
    }
    
    .searchable-select-input:focus {
      outline: none;
      border-color: #1E90FF;
      box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
    }
    
    .searchable-select-input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      color: #999;
    }
    
    .searchable-select-arrow {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      transition: transform 0.3s ease;
    }
    
    .searchable-select.active .searchable-select-arrow {
      transform: translateY(-50%) rotate(180deg);
    }
    
    .searchable-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 0.25rem;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
    }
    
    .searchable-select.active .searchable-select-dropdown {
      display: block;
    }
    
    .searchable-select-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .searchable-select-option:hover {
      background: #f8f9fa;
    }
    
    .searchable-select-option.selected {
      background: #1E90FF;
      color: white;
    }
    
    .searchable-select-option.hidden {
      display: none;
    }
    
    .searchable-select-no-results {
      padding: 1rem;
      text-align: center;
      color: #999;
      font-style: italic;
    }
    
    /* Hide the actual select element */
    .searchable-select select {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    
    /* ========== BLUE THEME OVERRIDES ========== */
    
    /* Page background */
    body {
      background: linear-gradient(135deg, #F0F8FF 0%, #E8F4FF 50%, #E0F0FF 100%) !important;
      background-attachment: fixed !important;
    }
    
    /* Profile cards */
    .profile-card,
    .profile-section,
    .card {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.1) !important;
    }
    
    /* Form inputs */
    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    textarea,
    select {
      background: #F7F9FC !important;
      border: 2px solid #E4E6EB !important;
      color: #1A3A52 !important;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
      background: #FFFFFF !important;
      border-color: #1E90FF !important;
      box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1) !important;
    }
    
    /* Buttons */
    .btn-primary,
    button[type="submit"],
    .save-btn {
      background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%) !important;
      border: none !important;
      color: white !important;
    }
    
    .btn-primary:hover,
    button[type="submit"]:hover {
      background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%) !important;
    }
    
    .btn-secondary,
    .cancel-btn {
      background: rgba(255, 255, 255, 0.9) !important;
      border: 2px solid rgba(30, 144, 255, 0.2) !important;
      color: #1A3A52 !important;
    }
    
    .btn-secondary:hover {
      background: rgba(30, 144, 255, 0.08) !important;
      border-color: rgba(30, 144, 255, 0.3) !important;
    }
    
    /* Section titles */
    h1, h2, h3, h4, h5, h6 {
      color: #1A3A52 !important;
    }
    
    h2::after,
    h3::after,
    .section-title::after {
      background: linear-gradient(90deg, #1E90FF, #4169E1) !important;
    }
    
    /* Labels and text */
    label {
      color: #1A3A52 !important;
    }
    
    .text-muted,
    .help-text {
      color: #7A9AB2 !important;
    }
    
    /* Profile avatar upload */
    .avatar-upload-btn {
      background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%) !important;
      color: white !important;
    }
    
    /* Analytics Header */
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 0 4px;
    }
    
    .analytics-title {
      font-size: 24px;
      font-weight: 800;
      color: #1A3A52;
      margin: 0;
    }
    
    /* Analytics Grid */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .analytics-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(30, 144, 255, 0.15);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.08);
    }
    
    .analytics-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(30, 144, 255, 0.15);
      border-color: rgba(30, 144, 255, 0.25);
    }
    
    .analytics-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .analytics-icon svg {
      width: 28px;
      height: 28px;
      color: white;
      stroke-width: 2;
    }
    
    .analytics-content {
      flex: 1;
    }
    
    .analytics-value {
      font-size: 32px;
      font-weight: 800;
      color: #1A3A52;
      line-height: 1.1;
      margin-bottom: 6px;
    }
    
    .analytics-label {
      font-size: 10.5px;
      font-weight: 600;
      color: #7A9AB2;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      line-height: 1.4;
      min-height: 28px;
      display: flex;
      align-items: center;
    }
    
    /* Responsive Analytics Grid */
    @media (max-width: 1200px) {
      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 640px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-card {
        padding: 20px;
      }
      
      .analytics-icon {
        width: 48px;
        height: 48px;
      }
      
      .analytics-icon svg {
        width: 24px;
        height: 24px;
      }
      
      .analytics-value {
        font-size: 24px;
      }
      
      .analytics-label {
        font-size: 12px;
      }
    }
    
    /* Section Header Actions */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .section-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sort-select {
      padding: 8px 32px 8px 12px;
      border: 2px solid rgba(30, 144, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 500;
      color: #1A3A52;
      cursor: pointer;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231E90FF' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    
    .sort-select:hover {
      border-color: rgba(30, 144, 255, 0.4);
      background-color: rgba(240, 248, 255, 0.9);
    }
    
    .sort-select:focus {
      outline: none;
      border-color: #1E90FF;
      box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
    }
    
    @media (max-width: 640px) {
      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .section-header-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .sort-select {
        flex: 1;
      }
    }
    
    /* Success messages */
    .alert-success {
      background: #D1FAE5 !important;
      border-color: #10B981 !important;
      color: #065F46 !important;
    }
    
    /* Error messages */
    .alert-error,
    .alert-danger {
      background: #FEE2E2 !important;
      border-color: #EF4444 !important;
      color: #991B1B !important;
    }
    
    /* Tab navigation */
    .tabs,
    .tab-navigation,
    .profile-tabs,
    .nav-tabs,
    .profile-nav,
    [role="tablist"] {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    /* Tab container wrapper */
    .tabs-container,
    .profile-tabs-wrapper {
      background: transparent !important;
    }
    
    .tab,
    .tab-btn,
    .nav-tab {
      background: transparent !important;
      color: #5A7A92 !important;
      border: none !important;
    }
    
    .tab:hover,
    .tab-btn:hover,
    .nav-tab:hover {
      background: rgba(30, 144, 255, 0.08) !important;
      color: #1E90FF !important;
    }
    
    .tab.active,
    .tab-btn.active,
    .nav-tab.active {
      background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%) !important;
      color: white !important;
    }
    
    /* Recent Activity section */
    .recent-activity,
    .activity-list {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    .activity-item {
      background: #FFFFFF !important;
      border-bottom: 1px solid rgba(30, 144, 255, 0.1) !important;
    }
    
    .activity-item:hover {
      background: rgba(240, 248, 255, 0.5) !important;
    }
    
    .activity-icon {
      background: rgba(30, 144, 255, 0.1) !important;
      color: #1E90FF !important;
    }
    
    /* Saved Posts section */
    .saved-posts,
    .saved-posts-section {
      background: rgba(255, 255, 255, 0.95) !important;
      border: 1px solid rgba(30, 144, 255, 0.15) !important;
    }
    
    .empty-state {
      background: #FFFFFF !important;
      color: #7A9AB2 !important;
    }
    
    .empty-state svg {
      color: #7A9AB2 !important;
    }
    
    /* View All link */
    .view-all,
    a[href*="activity"] {
      color: #1E90FF !important;
    }
    
    .view-all:hover {
      color: #4169E1 !important;
    }
    
    /* Override any remaining beige/cream backgrounds */
    div[style*="background: #FFF8DC"],
    div[style*="background: #FAF6E8"],
    div[style*="background: #F4E6D0"],
    section[style*="background: #FFF8DC"],
    div[style*="background-color: #FFF8DC"],
    div[style*="background-color: #FAF6E8"],
    div[style*="background-color: #F4E6D0"] {
      background: rgba(255, 255, 255, 0.95) !important;
      background-color: rgba(255, 255, 255, 0.95) !important;
    }
    
    /* Aggressive override for all tab-related elements */
    [class*="tab"][class*="container"],
    [class*="tab"][class*="wrapper"],
    [class*="profile"][class*="tab"] {
      background: rgba(255, 255, 255, 0.95) !important;
    }
    
    /* Settings sections - increase height and spacing */
    .settings-section,
    .notification-item,
    .preference-item,
    .setting-item {
      padding: 1.5rem !important;
      min-height: 80px !important;
      margin-bottom: 1rem !important;
    }
    
    .settings-section h3,
    .setting-title {
      margin-bottom: 0.5rem !important;
      font-size: 1.1rem !important;
    }
    
    .settings-section p,
    .setting-description {
      margin-bottom: 0 !important;
      line-height: 1.6 !important;
    }
    
    /* Settings sidebar items */
    .settings-sidebar .nav-item,
    .settings-nav-item {
      padding: 1rem 1.25rem !important;
      min-height: 60px !important;
      margin-bottom: 0.5rem !important;
    }
    
    /* Toggle switches - better alignment */
    .toggle-switch,
    .switch {
      margin: 0.5rem 0 !important;
    }
    
    /* ========== DONATION RANKING STYLES ========== */
    .donation-ranking-section {
      margin-bottom: 32px;
    }
    
    .ranking-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(30, 144, 255, 0.15);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.08);
      max-width: 900px;
      margin: 0 auto;
    }
    
    .ranking-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .ranking-title {
      font-size: 20px;
      font-weight: 700;
      color: #1A3A52;
      margin: 0;
    }
    
    .rank-info-btn {
      background: rgba(30, 144, 255, 0.1);
      border: 2px solid rgba(30, 144, 255, 0.2);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #1E90FF;
    }
    
    .rank-info-btn:hover {
      background: rgba(30, 144, 255, 0.2);
      border-color: #1E90FF;
      transform: scale(1.1);
    }
    
    /* No Rank Card */
    .no-rank-card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(30, 144, 255, 0.15);
      border-radius: 16px;
      padding: 48px 28px;
      box-shadow: 0 4px 12px rgba(30, 144, 255, 0.08);
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }
    
    .no-rank-icon {
      margin-bottom: 24px;
      color: #7A9AB2;
    }
    
    .no-rank-title {
      font-size: 24px;
      font-weight: 700;
      color: #1A3A52;
      margin: 0 0 16px 0;
    }
    
    .no-rank-description {
      font-size: 16px;
      line-height: 1.6;
      color: #5A7A92;
      margin: 0 0 28px 0;
    }
    
    .rank-info-btn-large {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .rank-info-btn-large:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(30, 144, 255, 0.3);
    }
    
    .rank-badge-container {
      display: flex;
      justify-content: center;
      margin: 24px 0;
    }
    
    .rank-badge {
      padding: 32px;
      border-radius: 20px;
      text-align: center;
      color: white;
      min-width: 240px;
      transition: transform 0.3s ease;
    }
    
    .rank-badge:hover {
      transform: translateY(-4px);
    }
    
    .rank-icon {
      margin-bottom: 16px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    }
    
    .rank-icon svg {
      color: white;
    }
    
    .rank-name {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .rank-amount {
      font-size: 32px;
      font-weight: 900;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .rank-progress-section {
      margin-top: 24px;
      padding: 20px;
      background: rgba(30, 144, 255, 0.05);
      border-radius: 12px;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .progress-label {
      font-size: 14px;
      font-weight: 600;
      color: #1A3A52;
    }
    
    .progress-amount {
      font-size: 13px;
      font-weight: 600;
      color: #7A9AB2;
    }
    
    .progress-bar-container {
      height: 12px;
      background: rgba(30, 144, 255, 0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.5s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-percentage {
      text-align: right;
      font-size: 14px;
      font-weight: 700;
      color: #1E90FF;
    }
    
    .rank-max-achieved {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      border-radius: 12px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 700;
    }
    
    /* Rank Info Modal */
    .rank-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .rank-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
    
    .rank-modal-content {
      position: relative;
      background: white;
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .rank-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 28px;
      border-bottom: 2px solid rgba(30, 144, 255, 0.1);
    }
    
    .rank-modal-header h2 {
      font-size: 24px;
      font-weight: 800;
      color: #1A3A52;
      margin: 0;
    }
    
    .rank-modal-close {
      background: rgba(30, 144, 255, 0.1);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #1E90FF;
    }
    
    .rank-modal-close:hover {
      background: rgba(30, 144, 255, 0.2);
      transform: rotate(90deg);
    }
    
    .rank-modal-body {
      padding: 28px;
    }
    
    .rank-modal-intro {
      font-size: 16px;
      line-height: 1.6;
      color: #5A7A92;
      margin-bottom: 28px;
      text-align: center;
    }
    
    .rank-tiers-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .rank-tier-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: rgba(30, 144, 255, 0.03);
      border: 2px solid rgba(30, 144, 255, 0.1);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .rank-tier-item:hover {
      background: rgba(30, 144, 255, 0.08);
      border-color: rgba(30, 144, 255, 0.2);
      transform: translateX(4px);
    }
    
    .rank-tier-badge {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .rank-tier-info {
      flex: 1;
    }
    
    .rank-tier-name {
      font-size: 18px;
      font-weight: 700;
      color: #1A3A52;
      margin: 0 0 4px 0;
    }
    
    .rank-tier-range {
      font-size: 14px;
      font-weight: 600;
      color: #1E90FF;
      margin: 0 0 8px 0;
    }
    
    .rank-tier-description {
      font-size: 14px;
      line-height: 1.5;
      color: #7A9AB2;
      margin: 0;
    }
    
    .rank-modal-footer {
      margin-top: 24px;
      padding: 20px;
      background: rgba(30, 144, 255, 0.05);
      border-radius: 12px;
    }
    
    .rank-modal-footer p {
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
      color: #5A7A92;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .ranking-card {
        padding: 20px;
      }
      
      .rank-badge {
        min-width: 200px;
        padding: 24px;
      }
      
      .rank-name {
        font-size: 20px;
      }
      
      .rank-amount {
        font-size: 28px;
      }
      
      .rank-modal-content {
        max-height: 95vh;
      }
      
      .rank-modal-header {
        padding: 20px;
      }
      
      .rank-modal-body {
        padding: 20px;
      }
      
      .rank-tier-item {
        flex-direction: column;
        text-align: center;
        padding: 16px;
      }
      
      .rank-tier-badge {
        width: 56px;
        height: 56px;
      }
    }
  </style>
{% endblock %}

{% block sidebar %}
  {% include 'partials/sidebar.html' %}
{% endblock %}

{% block topbar %}
  {% include 'partials/topbar.html' %}
{% endblock %}

{# Keep the default profile JS from app_base.html #}

{% block content %}
<div class="profile-page warm-sacred-earth">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">My Profile</h1>
  </div>

  <!-- Profile Card -->
  <div class="profile-card">
    <div class="profile-avatar-section">
      <div class="profile-avatar">
        {% if profile_image_url %}
          <img src="{{ profile_image_url }}" alt="Profile Picture" class="avatar-image" decoding="async">
        {% elif profile.profile_image %}
          <img src="{{ profile.profile_image.url }}" alt="Profile Picture" class="avatar-image" decoding="async">
        {% else %}
          <div class="avatar-placeholder">{{ user_initial }}</div>
        {% endif %}
        <button class="avatar-upload-btn" onclick="document.getElementById('id_profile_image').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="profile-details">
      <div class="profile-name-section">
        <h2 class="profile-name">{{ user_display_name }}</h2>
        {% if current_rank and profile.show_donation_rank %}
        <span class="status-badge rank-badge-{{ current_rank.icon }}" style="background: {{ current_rank.color }}22; color: {{ current_rank.color }}; border: 2px solid {{ current_rank.color }}44;">
          {{ current_rank.name }}
        </span>
        {% endif %}
      </div>
      
      <div class="profile-email">{{ user.email }}</div>
      
      {% if profile.bio %}
        <div class="profile-bio">{{ profile.bio }}</div>
      {% else %}
        <div class="profile-bio">Passionate about community service and faith-based connections.</div>
      {% endif %}
      
      <div class="profile-meta">
        <div class="meta-item">
          <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span>Member since {{ user.date_joined|date:"F Y" }}</span>
        </div>
        {% if profile.street_address or profile.barangay or profile.city_municipality or profile.province %}
        <div class="meta-item">
          <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>{% if profile.street_address %}{{ profile.street_address }}, {% endif %}{% if profile.barangay %}Brgy. {{ profile.barangay }}, {% endif %}{% if profile.city_municipality %}{{ profile.city_municipality }}, {% endif %}{% if profile.province %}{{ profile.province }}{% endif %}{% if profile.region %}, {{ profile.region }}{% endif %}{% if profile.postal_code %}, {{ profile.postal_code }}{% endif %}</span>
        </div>
        {% endif %}
      </div>
    </div>
    
    <div class="profile-actions">
      <button class="edit-profile-btn" onclick="openProfileEditModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Edit Profile
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="profile-nav">
    <button class="nav-tab active" data-tab="overview">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Overview
    </button>
    <button class="nav-tab" data-tab="activity">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12,6 12,12 16,14"/>
      </svg>
      Activity
    </button>
    <button class="nav-tab" data-tab="donations">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
      </svg>
      Donations
    </button>
    <button class="nav-tab" data-tab="settings">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00-.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
      Settings
    </button>
  </div>

  <!-- Overview Tab Content -->
  <div id="overview-content" class="tab-content">
    <!-- Analytics Header with Sorting -->
    <div class="analytics-header">
      <h3 class="analytics-title">Your Statistics</h3>
      <select id="analytics-period" class="sort-select">
        <option value="all">All Time</option>
        <option value="month">This Month</option>
        <option value="week">This Week</option>
        <option value="today">Today</option>
      </select>
    </div>
    
    <!-- Analytics Cards -->
    <div class="analytics-grid">
      <div class="analytics-card" data-type="bookings" 
           data-all="{{ total_bookings|default:0 }}"
           data-month="{{ total_bookings_month|default:0 }}"
           data-week="{{ total_bookings_week|default:0 }}"
           data-today="{{ total_bookings_today|default:0 }}">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
        </div>
        <div class="analytics-content">
          <div class="analytics-value">{{ total_bookings|default:0 }}</div>
          <div class="analytics-label">Bookings</div>
        </div>
      </div>

      <div class="analytics-card" data-type="donated"
           data-all="{{ total_donated|default:0|floatformat:0 }}"
           data-month="{{ total_donated_month|default:0|floatformat:0 }}"
           data-week="{{ total_donated_week|default:0|floatformat:0 }}"
           data-today="{{ total_donated_today|default:0|floatformat:0 }}">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </div>
        <div class="analytics-content">
          <div class="analytics-value">₱{{ total_donated|default:0|floatformat:0 }}</div>
          <div class="analytics-label">Donated</div>
        </div>
      </div>

      <div class="analytics-card" data-type="parishes"
           data-all="{{ total_parishes_followed|default:0 }}"
           data-month="{{ total_parishes_followed_month|default:0 }}"
           data-week="{{ total_parishes_followed_week|default:0 }}"
           data-today="{{ total_parishes_followed_today|default:0 }}">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div class="analytics-content">
          <div class="analytics-value">{{ total_parishes_followed|default:0 }}</div>
          <div class="analytics-label">Parishes</div>
        </div>
      </div>

      <div class="analytics-card" data-type="engagement"
           data-all="{{ total_post_engagement|default:0 }}"
           data-month="{{ total_post_engagement_month|default:0 }}"
           data-week="{{ total_post_engagement_week|default:0 }}"
           data-today="{{ total_post_engagement_today|default:0 }}">
        <div class="analytics-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <div class="analytics-content">
          <div class="analytics-value">{{ total_post_engagement|default:0 }}</div>
          <div class="analytics-label">Engagements</div>
        </div>
      </div>
    </div>

    <div class="overview-grid">
      <!-- Recent Activity Section -->
      <div id="recent-activity-section" class="overview-section">
        <div class="section-header">
          <h3 class="section-title">Recent Activity</h3>
          <div class="section-header-actions">
            <select id="activity-sort" class="sort-select">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="type">By Type</option>
            </select>
            <a href="{% url 'core:user_activities' %}" class="view-all-link">View All</a>
          </div>
        </div>
        <div class="activity-list" id="activity-list">
          {% if profile_activities %}
            {% for activity in profile_activities %}
              <div class="activity-item">
                <div class="activity-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    {% if activity.icon_class == 'heart' %}
                      <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                    {% elif activity.icon_class == 'message-circle' %}
                      <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    {% elif activity.icon_class == 'bookmark' %}
                      <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                    {% elif activity.icon_class == 'eye' %}
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    {% elif activity.icon_class == 'user-plus' %}
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                      <path d="M16 11h4"/>
                      <path d="M18 9v4"/>
                    {% elif activity.icon_class == 'user-minus' %}
                      <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                      <path d="M14 11h6"/>
                    {% elif activity.icon_class == 'calendar-plus' %}
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                      <path d="M12 14h4"/>
                      <path d="M14 12v4"/>
                    {% elif activity.icon_class == 'edit' %}
                      <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    {% else %}
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12,6 12,12 16,14"/>
                    {% endif %}
                  </svg>
                </div>
                <div class="activity-content">
                  <div class="activity-text">{{ activity.activity_description }}</div>
                  <div class="activity-meta">{{ activity.created_at|timesince }} ago</div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-activity">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                  <line x1="9" y1="9" x2="9.01" y2="9"/>
                  <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
              </div>
              <h4>No recent activity</h4>
              <p>Start interacting with posts and churches to see your activity here.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Saved Posts Section -->
      <div class="overview-section">
        <div class="section-header">
          <h3 class="section-title">Saved Posts</h3>
          {% if saved_posts %}
            <span class="view-all-link">{{ saved_posts|length }} post{{ saved_posts|length|pluralize }}</span>
          {% endif %}
        </div>
        <div class="saved-posts-list">
          {% if saved_posts %}
            {% for post in saved_posts %}
              <div class="saved-post-item">
                <div class="post-avatar">
                  {% if post.church.logo %}
                    <img src="{{ post.church.logo.url }}" alt="{{ post.church.name }}" loading="lazy" decoding="async">
                  {% else %}
                    <div class="post-avatar-placeholder">{{ post.church.initial }}</div>
                  {% endif %}
                </div>
                <div class="post-content">
                  <div class="post-header">
                    <div class="post-author">
                      <a href="{% url 'core:church_detail' slug=post.church.slug %}" class="church-name-link">
                        {{ post.church.name }}
                      </a>
                    </div>
                    <div class="post-time">{{ post.time_ago }}</div>
                  </div>
                  <div class="post-text" data-full-text="{{ post.content|escape }}">
                    {{ post.content|truncatewords:15 }}
                    {% if post.content|wordcount > 15 %}
                      <button class="show-more-btn" type="button">Show more</button>
                    {% endif %}
                  </div>
                  {% if post.image %}
                    <div class="post-image-preview">
                      <img src="{{ post.image.url }}" alt="Post image" loading="lazy" decoding="async">
                    </div>
                  {% endif %}
                  <div class="post-actions">
                    <button class="post-action-btn" title="Likes">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                      </svg>
                      <span>{{ post.like_count }}</span>
                    </button>
                    <button class="post-action-btn" title="Comments">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                      </svg>
                      <span>{{ post.comment_count }}</span>
                    </button>
                    <button class="post-action-btn bookmark-action bookmarked" data-post-id="{{ post.id }}" data-action="bookmark" title="Remove from saved">
                      <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="empty-saved-posts">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                </svg>
              </div>
              <h4>No saved posts yet</h4>
              <p>Posts you save will appear here for easy access later.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Activity Tab Content -->
  <div id="activity-content" class="tab-content" style="display: none;">
    <div class="activity-page-content">
      <div class="section-header">
        <h2 class="section-title">All Activity</h2>
        <p class="section-description">Your complete activity history</p>
      </div>
      <div class="activity-list" id="activity-list-container">
        {% if profile_activities %}
          {% for activity in profile_activities %}
            <div class="activity-item activity-type-{{ activity.activity_type }}">
              <div class="activity-icon activity-icon-{{ activity.activity_type }}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  {% if activity.icon_class == 'heart' %}
                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                  {% elif activity.icon_class == 'message-circle' %}
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                  {% elif activity.icon_class == 'bookmark' %}
                    <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/>
                  {% elif activity.icon_class == 'eye' %}
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  {% elif activity.icon_class == 'user-plus' %}
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                    <path d="M16 11h4"/>
                    <path d="M18 9v4"/>
                  {% elif activity.icon_class == 'user-minus' %}
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                    <path d="M14 11h6"/>
                  {% elif activity.icon_class == 'calendar-plus' %}
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                    <path d="M12 14h4"/>
                    <path d="M14 12v4"/>
                  {% elif activity.icon_class == 'edit' %}
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  {% else %}
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                  {% endif %}
                </svg>
              </div>
              <div class="activity-content">
                <div class="activity-text">{{ activity.activity_description }}</div>
                {% if activity.content_object %}
                  <div class="activity-details">
                    {% if activity.content_object.church %}
                      <span class="activity-church">{{ activity.content_object.church.name }}</span>
                      {% if activity.content_object.content %}
                        <span class="activity-preview">{{ activity.content_object.content|truncatewords:15 }}</span>
                      {% endif %}
                    {% elif activity.content_object.name %}
                      <span class="activity-item-name">{{ activity.content_object.name }}</span>
                    {% endif %}
                  </div>
                {% endif %}
                <div class="activity-meta">{{ activity.created_at|timesince }} ago</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-activity">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                <line x1="9" y1="9" x2="9.01" y2="9"/>
                <line x1="15" y1="9" x2="15.01" y2="9"/>
              </svg>
            </div>
            <h4>No activity yet</h4>
            <p>Start interacting with posts and churches to see your activity here.</p>
          </div>
        {% endif %}
      </div>
      
      {% if profile_activities and profile_activities|length >= 10 %}
      <div class="activity-pagination">
        <button class="btn btn-secondary load-more-activities" id="load-more-activities" data-offset="10">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
          Load More Activities
        </button>
        <div class="loading-spinner" id="activity-loading" style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
          </svg>
          Loading...
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Donations Tab Content -->
  <div id="donations-content" class="tab-content" style="display: none;">
    <div class="donations-page-content">
      <!-- Donation Stats Summary -->
      <div class="donation-stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">₱{{ total_donated|floatformat:2 }}</div>
            <div class="stat-label">Total Donated</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ donation_count }}</div>
            <div class="stat-label">Donations Made</div>
          </div>
        </div>
      </div>

      <!-- Donation Ranking Section -->
      <div class="donation-ranking-section">
        {% if current_rank %}
        <div class="ranking-card">
          <div class="ranking-header">
            <h3 class="ranking-title">Your Donor Rank</h3>
            <button class="rank-info-btn" onclick="openRankInfoModal()" type="button" title="Learn about ranking tiers">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
            </button>
          </div>
          
          <div class="rank-badge-container">
            <div class="rank-badge" style="background: linear-gradient(135deg, {{ current_rank.color }}dd 0%, {{ current_rank.color }} 100%); box-shadow: 0 8px 24px {{ current_rank.color }}40;">
              <div class="rank-icon">
                {% if current_rank.icon == 'bronze' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                  </svg>
                {% elif current_rank.icon == 'silver' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    <circle cx="12" cy="12" r="3" fill="white" opacity="0.3"/>
                  </svg>
                {% elif current_rank.icon == 'gold' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    <path d="M12 8L13.5 11L17 11.5L14.5 14L15 17.5L12 15.5L9 17.5L9.5 14L7 11.5L10.5 11L12 8Z" fill="white" opacity="0.4"/>
                  </svg>
                {% elif current_rank.icon == 'platinum' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    <circle cx="12" cy="9" r="2" fill="white" opacity="0.5"/>
                    <circle cx="9" cy="13" r="1.5" fill="white" opacity="0.5"/>
                    <circle cx="15" cy="13" r="1.5" fill="white" opacity="0.5"/>
                  </svg>
                {% elif current_rank.icon == 'diamond' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2L2 9L12 22L22 9L12 2Z"/>
                    <path d="M12 2L7 9L12 16L17 9L12 2Z" fill="white" opacity="0.3"/>
                  </svg>
                {% elif current_rank.icon == 'champion' %}
                  <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M6 9C6 10.5 7 11.5 8 12C6.5 13 6 14.5 6 16C6 18.5 8 20 10 20H14C16 20 18 18.5 18 16C18 14.5 17.5 13 16 12C17 11.5 18 10.5 18 9C18 6.5 16 5 14 5H10C8 5 6 6.5 6 9Z"/>
                    <circle cx="12" cy="3" r="2"/>
                  </svg>
                {% endif %}
              </div>
              <div class="rank-name">{{ current_rank.name }}</div>
              <div class="rank-amount">₱{{ total_donated|floatformat:0 }}</div>
            </div>
          </div>
          
          {% if next_rank %}
          <div class="rank-progress-section">
            <div class="progress-header">
              <span class="progress-label">Progress to {{ next_rank.name }}</span>
              <span class="progress-amount">₱{{ amount_to_next_rank|floatformat:0 }} to go</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar-fill" style="width: {{ progress_percentage }}%; background: linear-gradient(90deg, {{ current_rank.color }}, {{ next_rank.color }});"></div>
            </div>
            <div class="progress-percentage">{{ progress_percentage|floatformat:1 }}%</div>
          </div>
          {% else %}
          <div class="rank-max-achieved">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>Maximum Rank Achieved!</span>
          </div>
          {% endif %}
        </div>
        {% else %}
        <!-- No Rank Yet - Show Encouragement Message -->
        <div class="no-rank-card">
          <div class="no-rank-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
              <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
            </svg>
          </div>
          <h3 class="no-rank-title">Start Your Giving Journey</h3>
          <p class="no-rank-description">
            Make your first donation of at least ₱50 to earn your Bronze Supporter rank and join our community of generous supporters!
          </p>
          <button class="rank-info-btn-large" onclick="openRankInfoModal()" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Learn About Ranks
          </button>
        </div>
        {% endif %}
      </div>

      <!-- Donations Table -->
      <div class="section-header" id="donations-section">
        <h2 class="section-title">Donation History</h2>
        <p class="section-description">Track all your donations and their status</p>
      </div>
      
      <div class="donations-table-container" id="donations-table-wrapper">
        <table class="donations-table" id="donations-table">
          <thead>
            <tr>
              <th>Church</th>
              <th>Post</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Method</th>
            </tr>
          </thead>
          <tbody>
            {% if user_donations %}
              {% for donation in user_donations %}
                <tr class="donation-row status-{{ donation.payment_status }}">
                  <td class="church-cell">
                    <div class="church-info">
                      <div class="church-avatar-small">
                        {% if donation.post.church.logo %}
                          <img src="{{ donation.post.church.logo.url }}" alt="{{ donation.post.church.name }}" loading="lazy" decoding="async">
                        {% else %}
                          <div class="church-avatar-placeholder-small">{{ donation.post.church.name|first|upper }}</div>
                        {% endif %}
                      </div>
                      <a href="{% url 'core:church_detail' slug=donation.post.church.slug %}" class="church-link">
                        {{ donation.post.church.name }}
                      </a>
                    </div>
                  </td>
                  <td class="post-cell">
                    <div class="post-preview">{{ donation.post.content|truncatewords:8 }}</div>
                    {% if donation.message %}
                      <div class="donation-message-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                        </svg>
                        "{{ donation.message|truncatewords:5 }}"
                      </div>
                    {% endif %}
                  </td>
                  <td class="amount-cell">
                    <span class="amount-value">₱{{ donation.amount|floatformat:2 }}</span>
                  </td>
                  <td class="status-cell">
                    <span class="status-badge status-{{ donation.payment_status }}">
                      {% if donation.payment_status == 'completed' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Completed
                      {% elif donation.payment_status == 'pending' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Pending
                      {% elif donation.payment_status == 'failed' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <circle cx="12" cy="12" r="10"/>
                          <line x1="15" y1="9" x2="9" y2="15"/>
                          <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        Failed
                      {% elif donation.payment_status == 'cancelled' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <circle cx="12" cy="12" r="10"/>
                          <line x1="15" y1="9" x2="9" y2="15"/>
                          <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        Cancelled
                      {% elif donation.payment_status == 'refunded' %}
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                          <polyline points="1 4 1 10 7 10"/>
                          <polyline points="23 20 23 14 17 14"/>
                          <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                        </svg>
                        Refunded
                      {% endif %}
                    </span>
                  </td>
                  <td class="date-cell">
                    {{ donation.created_at|date:"M d, Y" }}
                  </td>
                  <td class="method-cell">
                    {% if donation.payment_method == 'paypal' %}
                      <span class="payment-method">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                          <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 0 0-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 0 0-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 0 0 .554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.76-4.852a.932.932 0 0 1 .922-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z"/>
                        </svg>
                        PayPal
                      </span>
                    {% elif donation.payment_method == 'stripe' %}
                      <span class="payment-method">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                          <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        Card
                      </span>
                    {% else %}
                      {{ donation.get_payment_method_display }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="empty-row">
                  <div class="empty-donations">
                    <div class="empty-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                      </svg>
                    </div>
                    <h4>No donations yet</h4>
                    <p>When you make donations to churches, they will appear here.</p>
                    <a href="{% url 'core:discover' %}" class="btn btn-primary" style="margin-top: 1rem;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                      </svg>
                      Discover Churches
                    </a>
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination Controls -->
      {% if user_donations.has_other_pages %}
      <div class="pagination-container" style="margin-top: 1.5rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;">
        {% if user_donations.has_previous %}
          <button class="pagination-btn" data-page="1" onclick="loadDonationsPage(1)" title="First page">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="11 17 6 12 11 7"/>
              <polyline points="18 17 13 12 18 7"/>
            </svg>
          </button>
          <button class="pagination-btn" data-page="{{ user_donations.previous_page_number }}" onclick="loadDonationsPage({{ user_donations.previous_page_number }})" title="Previous page">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </button>
        {% else %}
          <span class="pagination-btn disabled">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="11 17 6 12 11 7"/>
              <polyline points="18 17 13 12 18 7"/>
            </svg>
          </span>
          <span class="pagination-btn disabled">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
          </span>
        {% endif %}
        
        <span class="pagination-info" id="donations-pagination-info" style="padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.875rem; font-weight: 600; color: #374151;">
          Page <span id="current-page">{{ user_donations.number }}</span> of <span id="total-pages">{{ user_donations.paginator.num_pages }}</span>
        </span>
        
        {% if user_donations.has_next %}
          <button class="pagination-btn" data-page="{{ user_donations.next_page_number }}" onclick="loadDonationsPage({{ user_donations.next_page_number }})" title="Next page">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </button>
          <button class="pagination-btn" data-page="{{ user_donations.paginator.num_pages }}" onclick="loadDonationsPage({{ user_donations.paginator.num_pages }})" title="Last page">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="13 17 18 12 13 7"/>
              <polyline points="6 17 11 12 6 7"/>
            </svg>
          </button>
        {% else %}
          <span class="pagination-btn disabled">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="9 18 15 12 9 6"/>
            </svg>
          </span>
          <span class="pagination-btn disabled">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polyline points="13 17 18 12 13 7"/>
              <polyline points="6 17 11 12 6 7"/>
            </svg>
          </span>
        {% endif %}
      </div>
      {% endif %}
    </div>
    
    <!-- Rank Info Modal -->
    <div id="rankInfoModal" class="rank-modal" style="display: none;">
      <div class="rank-modal-overlay" onclick="closeRankInfoModal()"></div>
      <div class="rank-modal-content">
        <div class="rank-modal-header">
          <h2>Donor Ranking System</h2>
          <button class="rank-modal-close" onclick="closeRankInfoModal()" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        
        <div class="rank-modal-body">
          <p class="rank-modal-intro">
            Our donor ranking system recognizes and celebrates your generosity. As you contribute more, you'll advance through different tiers, each with its own unique badge and recognition.
          </p>
          
          <div class="rank-tiers-list">
            <!-- Bronze Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #CD7F32dd 0%, #CD7F32 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Bronze Supporter</h3>
                <p class="rank-tier-range">₱50 - ₱999</p>
                <p class="rank-tier-description">Every journey begins with a single step. Thank you for starting yours with us!</p>
              </div>
            </div>
            
            <!-- Silver Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #C0C0C0dd 0%, #C0C0C0 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                  <circle cx="12" cy="12" r="3" fill="white" opacity="0.3"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Silver Supporter</h3>
                <p class="rank-tier-range">₱1,000 - ₱4,999</p>
                <p class="rank-tier-description">Your continued support makes a meaningful difference in our community.</p>
              </div>
            </div>
            
            <!-- Gold Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #FFD700dd 0%, #FFD700 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                  <path d="M12 8L13.5 11L17 11.5L14.5 14L15 17.5L12 15.5L9 17.5L9.5 14L7 11.5L10.5 11L12 8Z" fill="white" opacity="0.4"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Gold Supporter</h3>
                <p class="rank-tier-range">₱5,000 - ₱9,999</p>
                <p class="rank-tier-description">Your generosity shines bright and helps us reach more people in need.</p>
              </div>
            </div>
            
            <!-- Platinum Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #8B9DC3dd 0%, #8B9DC3 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                  <circle cx="12" cy="9" r="2" fill="white" opacity="0.5"/>
                  <circle cx="9" cy="13" r="1.5" fill="white" opacity="0.5"/>
                  <circle cx="15" cy="13" r="1.5" fill="white" opacity="0.5"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Platinum Supporter</h3>
                <p class="rank-tier-range">₱10,000 - ₱24,999</p>
                <p class="rank-tier-description">An exceptional supporter whose impact creates lasting change.</p>
              </div>
            </div>
            
            <!-- Diamond Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #B9F2FFdd 0%, #B9F2FF 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M12 2L2 9L12 22L22 9L12 2Z"/>
                  <path d="M12 2L7 9L12 16L17 9L12 2Z" fill="white" opacity="0.3"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Diamond Supporter</h3>
                <p class="rank-tier-range">₱25,000 - ₱49,999</p>
                <p class="rank-tier-description">A rare gem whose extraordinary generosity transforms lives.</p>
              </div>
            </div>
            
            <!-- Champion Tier -->
            <div class="rank-tier-item">
              <div class="rank-tier-badge" style="background: linear-gradient(135deg, #9D00FFdd 0%, #9D00FF 100%);">
                <svg viewBox="0 0 24 24" fill="white" width="32" height="32">
                  <path d="M6 9C6 10.5 7 11.5 8 12C6.5 13 6 14.5 6 16C6 18.5 8 20 10 20H14C16 20 18 18.5 18 16C18 14.5 17.5 13 16 12C17 11.5 18 10.5 18 9C18 6.5 16 5 14 5H10C8 5 6 6.5 6 9Z"/>
                  <circle cx="12" cy="3" r="2"/>
                </svg>
              </div>
              <div class="rank-tier-info">
                <h3 class="rank-tier-name">Champion of Faith</h3>
                <p class="rank-tier-range">₱50,000+</p>
                <p class="rank-tier-description">The highest honor - a true champion whose boundless generosity inspires us all.</p>
              </div>
            </div>
          </div>
          
          <div class="rank-modal-footer">
            <p><strong>Note:</strong> Rankings are based on your total completed donations across all parishes. Your rank advances automatically as you contribute more.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Tab Content -->
  <div id="settings-content" class="tab-content" style="display: none;">
    <div class="settings-layout">
      <!-- Settings Sidebar Navigation -->
      <div class="settings-sidebar">
        <div class="settings-nav-header">
          <h3>Settings</h3>
          <p>Manage your account preferences</p>
        </div>
        <nav class="settings-nav">
          <ul class="settings-nav-list">
            <li>
              <a href="#account-settings" class="settings-nav-link active" data-section="account-settings">
                <span class="icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </span>
                <span class="icon"><svg viewBox="0 0 24 24" fill="none"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"/></svg></span>
                <span class="nav-text">
                  <span class="nav-title">Privacy</span>
                  <span class="nav-subtitle">Visibility, contact info</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#notification-settings" class="settings-nav-link" data-section="notification-settings">
                <span class="icon"><svg viewBox="0 0 24 24" fill="none"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2"/><path d="M13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="2"/></svg></span>
                <span class="nav-text">
                  <span class="nav-title">Notifications</span>
                  <span class="nav-subtitle">Email, events, reminders</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#preferences-settings" class="settings-nav-link" data-section="preferences-settings">
                <span class="icon"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2"/></svg></span>
                <span class="nav-text">
                  <span class="nav-title">Preferences</span>
                  <span class="nav-subtitle">Language, theme, timezone</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#security-settings" class="settings-nav-link" data-section="security-settings">
                <span class="icon"><svg viewBox="0 0 24 24" fill="none"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke="currentColor" stroke-width="2"/></svg></span>
                <span class="nav-text">
                  <span class="nav-title">Security</span>
                  <span class="nav-subtitle">2FA, login history</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#data-settings" class="settings-nav-link" data-section="data-settings">
                <span class="icon"><svg viewBox="0 0 24 24" fill="none"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="2"/><polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2"/><line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/></svg></span>
                <span class="nav-text">
                  <span class="nav-title">Data</span>
                  <span class="nav-subtitle">Export, retention</span>
                </span>
              </a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Settings Content Area -->
      <div class="settings-content">
        <div class="settings-container">
      <!-- Account Settings Section -->
      <div id="account-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">Account Settings</h3>
          <p class="section-description">Manage your account information and security</p>
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Change Password</h4>
              <p class="setting-description">Update your password to keep your account secure</p>
            </div>
            <button class="setting-action-btn" onclick="openPasswordModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              Change Password
            </button>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Email Verification</h4>
              <p class="setting-description">Verify your email address to secure your account</p>
            </div>
            <div class="setting-status">
              <span class="status-badge verified">Verified</span>
              <button class="setting-action-btn secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                Resend
              </button>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Account Deletion</h4>
              <p class="setting-description">Permanently delete your account and all associated data</p>
            </div>
            <button class="setting-action-btn danger" onclick="openDeleteAccountModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
              </svg>
              Delete Account
            </button>
          </div>
        </div>
      </div>

      <!-- Privacy Settings Section -->
      <div id="privacy-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">Privacy Settings</h3>
          <p class="section-description">Control who can see your information and how it's shared</p>
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Profile Visibility</h4>
              <p class="setting-description">Control who can see your profile information</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Public Profile</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Contact Information</h4>
              <p class="setting-description">Show your phone number and address to other members</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Show Contact Info</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Activity Status</h4>
              <p class="setting-description">Let others see when you're online or recently active</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Show Activity</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Donation Rank Badge</h4>
              <p class="setting-description">Display your donor rank badge publicly on your profile</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" id="show_donation_rank" name="show_donation_rank" {% if profile.show_donation_rank %}checked{% endif %} onchange="updateDonationRankVisibility(this.checked)">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Show Rank Badge</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Notification Settings Section -->
      <div id="notification-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">Notification Settings</h3>
          <p class="section-description">Choose how and when you want to be notified</p>
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Email Notifications</h4>
              <p class="setting-description">Receive updates via email</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Enabled</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Event Reminders</h4>
              <p class="setting-description">Get reminded about upcoming church events</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Enabled</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Prayer Requests</h4>
              <p class="setting-description">Notify me about new prayer requests</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Enabled</span>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Newsletter</h4>
              <p class="setting-description">Receive weekly church newsletter</p>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" checked>
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Enabled</span>
            </div>
          </div>
        </div>
      </div>

      <!-- User Preferences Section -->
      <div id="preferences-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">User Preferences</h3>
          <p class="section-description">Customize your experience and display options</p>
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Language</h4>
              <p class="setting-description">Choose your preferred language</p>
            </div>
            <div class="setting-control">
              <select class="setting-select">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
              </select>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Timezone</h4>
              <p class="setting-description">Set your local timezone</p>
            </div>
            <div class="setting-control">
              <select class="setting-select">
                <option value="UTC-8">Pacific Time (UTC-8)</option>
                <option value="UTC-7">Mountain Time (UTC-7)</option>
                <option value="UTC-6">Central Time (UTC-6)</option>
                <option value="UTC-5">Eastern Time (UTC-5)</option>
                <option value="UTC+8">Philippines Time (UTC+8)</option>
              </select>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Theme</h4>
              <p class="setting-description">Choose your preferred color theme</p>
            </div>
            <div class="setting-control">
              <div class="theme-options">
                <label class="theme-option">
                  <input type="radio" name="theme" value="light" checked>
                  <span class="theme-preview light"></span>
                  <span class="theme-label">Light</span>
                </label>
                <label class="theme-option">
                  <input type="radio" name="theme" value="dark">
                  <span class="theme-preview dark"></span>
                  <span class="theme-label">Dark</span>
                </label>
                <label class="theme-option">
                  <input type="radio" name="theme" value="auto">
                  <span class="theme-preview auto"></span>
                  <span class="theme-label">Auto</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Settings Section -->
      <div id="security-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">Security Settings</h3>
          <p class="section-description">Manage your account security and login preferences</p>
        </div>
        <nav class="settings-nav">
          <ul class="settings-nav-list">
            <li>
              <a href="#account-settings" class="settings-nav-link active" data-section="account-settings">
                <span class="icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </span>
                <span class="nav-text">
                  <span class="nav-title">Account Settings</span>
                  <span class="nav-subtitle">Profile info, email, password</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#privacy-settings" class="settings-nav-link" data-section="privacy-settings">
                <span class="icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                </span>
                <span class="nav-text">
                  <span class="nav-title">Privacy Settings</span>
                  <span class="nav-subtitle">Profile visibility, data sharing</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#notification-settings" class="settings-nav-link" data-section="notification-settings">
                <span class="icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                  </svg>
                </span>
                <span class="nav-text">
                  <span class="nav-title">Notifications</span>
                  <span class="nav-subtitle">Email, push, system alerts</span>
                </span>
              </a>
            </li>
            <li>
              <a href="#security-settings" class="settings-nav-link" data-section="security-settings">
                <span class="icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  </svg>
                </span>
                <span class="nav-text">
                  <span class="nav-title">Security</span>
                  <span class="nav-subtitle">Two-factor, sessions, data</span>
                </span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Two-Factor Authentication</h4>
              <p class="setting-description">Add an extra layer of security to your account</p>
            </div>
            <div class="setting-status">
              <span class="status-badge disabled">Not Enabled</span>
              <button class="setting-action-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0110 0v4"/>
                </svg>
                Enable 2FA
              </button>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Login History</h4>
              <p class="setting-description">View recent login activity and sessions</p>
            </div>
            <button class="setting-action-btn" onclick="openLoginHistoryModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
              View History
            </button>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Active Sessions</h4>
              <p class="setting-description">Manage devices currently logged into your account</p>
            </div>
            <button class="setting-action-btn" onclick="openSessionsModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
              </svg>
              Manage Sessions
            </button>
          </div>
        </div>
      </div>

      <!-- Data Management Section -->
      <div id="data-settings" class="settings-section">
        <div class="section-header">
          <h3 class="section-title">Data Management</h3>
          <p class="section-description">Control your personal data and privacy</p>
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Download Data</h4>
              <p class="setting-description">Download a copy of all your personal data</p>
            </div>
            <button class="setting-action-btn" onclick="downloadUserData()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download Data
            </button>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4 class="setting-title">Data Retention</h4>
              <p class="setting-description">Control how long your data is stored</p>
            </div>
            <div class="setting-control">
              <select class="setting-select">
                <option value="1">1 Year</option>
                <option value="3" selected>3 Years</option>
                <option value="5">5 Years</option>
                <option value="indefinite">Indefinitely</option>
              </select>
            </div>
          </div>
        </div>
      </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-edit-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content profile-edit-modal">
      <div class="modal-header">
        <h3>Edit Profile</h3>
        <button class="modal-close" onclick="closeProfileEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        {% if messages %}
          <div class="messages">
            {% for message in messages %}
              <div class="message message-{{ message.tags }}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="profile-form" id="profile-edit-form" onsubmit="handleProfileFormSubmit(event)">
          {% csrf_token %}
          
          <!-- Hidden file input for avatar upload -->
          {{ form.profile_image }}
          
          <div class="form-sections">
            <!-- Personal Information Section -->
            <div class="form-section">
              <h2 class="section-title">Personal Information {% if personal_missing_count %}<span class="chip-missing">{{ personal_missing_count }} required</span>{% endif %}</h2>
              <div class="form-grid">
                <div class="form-group{% if essential_missing_map.display_name and not user.first_name %} is-missing{% endif %}">
                  <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                  {{ form.first_name }}
                  {% if form.first_name.errors %}
                    <div class="form-error">{{ form.first_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="form-group{% if essential_missing_map.display_name and not user.last_name %} is-missing{% endif %}">
                  <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                  {{ form.last_name }}
                  {% if form.last_name.errors %}
                    <div class="form-error">{{ form.last_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="form-group{% if essential_missing_map.display_name and not profile.display_name %} is-missing{% endif %}">
                  <label for="{{ form.display_name.id_for_label }}" class="form-label">Display Name</label>
                  {{ form.display_name }}
                  <small class="form-help">This is how your name appears to other users</small>
                  {% if form.display_name.errors %}
                    <div class="form-error">{{ form.display_name.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="form-group">
                  <label for="{{ form.email.id_for_label }}" class="form-label">Email Address</label>
                  {{ form.email }}
                  {% if form.email.errors %}
                    <div class="form-error">{{ form.email.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="form-section">
              <h2 class="section-title">Contact Information {% if contact_missing_count %}<span class="chip-missing">{{ contact_missing_count }} required</span>{% endif %}</h2>
              <div class="form-grid">
                <div class="form-group{% if essential_missing_map.phone %} is-missing{% endif %}">
                  <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number</label>
                  {{ form.phone }}
                  {% if form.phone.errors %}
                    <div class="form-error">{{ form.phone.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <!-- Philippine Address Fields -->
                <div class="form-group">
                  <label for="id_region" class="form-label">Region</label>
                  <div class="searchable-select" id="region-wrapper">
                    <input type="text" class="searchable-select-input" placeholder="Select or search region..." autocomplete="off">
                    <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                    <div class="searchable-select-dropdown"></div>
                    <select id="id_region" name="region" style="display: none;">
                      <option value="">Select Region</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="id_province" class="form-label">Province</label>
                  <div class="searchable-select" id="province-wrapper">
                    <input type="text" class="searchable-select-input" placeholder="Select region first..." autocomplete="off" disabled>
                    <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                    <div class="searchable-select-dropdown"></div>
                    <select id="id_province" name="province" style="display: none;" disabled>
                      <option value="">Select Province</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="id_city_municipality" class="form-label">City / Municipality</label>
                  <div class="searchable-select" id="city-wrapper">
                    <input type="text" class="searchable-select-input" placeholder="Select province first..." autocomplete="off" disabled>
                    <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                    <div class="searchable-select-dropdown"></div>
                    <select id="id_city_municipality" name="city_municipality" style="display: none;" disabled>
                      <option value="">Select City/Municipality</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="id_barangay" class="form-label">Barangay</label>
                  <div class="searchable-select" id="barangay-wrapper">
                    <input type="text" class="searchable-select-input" placeholder="Select city first..." autocomplete="off" disabled>
                    <svg class="searchable-select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                    </svg>
                    <div class="searchable-select-dropdown"></div>
                    <select id="id_barangay" name="barangay" style="display: none;" disabled>
                      <option value="">Select Barangay</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group form-group-full">
                  <label for="id_street_address" class="form-label">Street Address (House/Building No., Street Name)</label>
                  <input type="text" id="id_street_address" name="street_address" class="form-control" placeholder="e.g., 123 Rizal Street, Unit 4B">
                </div>
                
                <div class="form-group">
                  <label for="id_postal_code" class="form-label">Postal Code</label>
                  <input type="text" id="id_postal_code" name="postal_code" class="form-control" placeholder="e.g., 9000" maxlength="4" pattern="[0-9]{4}" title="Please enter a 4-digit postal code">
                  <small class="form-text text-muted">4-digit postal code</small>
                </div>
              </div>
            </div>

            <!-- Additional Information Section -->
            <div class="form-section">
              <h2 class="section-title">Additional Information {% if additional_missing_count %}<span class="chip-missing">{{ additional_missing_count }} required</span>{% endif %}</h2>
              <div class="form-grid">
                <div class="form-group{% if essential_missing_map.date_of_birth %} is-missing{% endif %}">
                  <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth</label>
                  {{ form.date_of_birth }}
                  {% if form.date_of_birth.errors %}
                    <div class="form-error">{{ form.date_of_birth.errors.0 }}</div>
                  {% endif %}
                </div>
                
                <div class="form-group form-group-full">
                  <label for="{{ form.bio.id_for_label }}" class="form-label">Bio / About Me</label>
                  {{ form.bio }}
                  <small class="form-help">Tell others about yourself</small>
                  {% if form.bio.errors %}
                    <div class="form-error">{{ form.bio.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeProfileEditModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="profile-save-btn">
              <span class="btn-text">Save Changes</span>
              <span class="btn-spinner" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="animate-spin">
                  <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{# CSRF Token for AJAX requests #}
{% csrf_token %}
<script>
  // Make CSRF token available for AJAX requests
  window.csrfToken = '{{ csrf_token }}';
  
  // AJAX Pagination for Donations Tab
  function loadDonationsPage(page) {
    const tableBody = document.querySelector('#donations-table tbody');
    const paginationContainer = document.querySelector('.pagination-container');
    
    // Show loading state
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #7A9AB2;"><svg style="animation: spin 1s linear infinite; width: 24px; height: 24px; margin: 0 auto;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" opacity="0.75"/></svg><br/>Loading...</td></tr>';
    
    // Fetch new page data
    fetch(`{% url 'manage_profile' %}?ajax=1&donations_page=${page}`, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update table body
        tableBody.innerHTML = data.html;
        
        // Update pagination info
        document.getElementById('current-page').textContent = data.current_page;
        document.getElementById('total-pages').textContent = data.total_pages;
        
        // Update pagination buttons
        updatePaginationButtons(data.current_page, data.total_pages, data.has_previous, data.has_next, data.previous_page, data.next_page);
        
        // Scroll to donations section smoothly
        document.getElementById('donations-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #EF4444;">Error loading donations. Please try again.</td></tr>';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #EF4444;">Error loading donations. Please try again.</td></tr>';
    });
  }
  
  function updatePaginationButtons(currentPage, totalPages, hasPrevious, hasNext, previousPage, nextPage) {
    const container = document.querySelector('.pagination-container');
    
    let html = '';
    
    // First and Previous buttons
    if (hasPrevious) {
      html += `
        <button class="pagination-btn" onclick="loadDonationsPage(1)" title="First page">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/>
          </svg>
        </button>
        <button class="pagination-btn" onclick="loadDonationsPage(${previousPage})" title="Previous page">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
      `;
    } else {
      html += `
        <span class="pagination-btn disabled">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/>
          </svg>
        </span>
        <span class="pagination-btn disabled">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </span>
      `;
    }
    
    // Page info
    html += `
      <span class="pagination-info" style="padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.875rem; font-weight: 600; color: #374151;">
        Page <span id="current-page">${currentPage}</span> of <span id="total-pages">${totalPages}</span>
      </span>
    `;
    
    // Next and Last buttons
    if (hasNext) {
      html += `
        <button class="pagination-btn" onclick="loadDonationsPage(${nextPage})" title="Next page">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
        <button class="pagination-btn" onclick="loadDonationsPage(${totalPages})" title="Last page">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/>
          </svg>
        </button>
      `;
    } else {
      html += `
        <span class="pagination-btn disabled">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </span>
        <span class="pagination-btn disabled">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/>
          </svg>
        </span>
      `;
    }
    
    container.innerHTML = html;
  }
  
  // Add CSS for loading spinner animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
  
  // Rank Info Modal Functions
  function openRankInfoModal() {
    const modal = document.getElementById('rankInfoModal');
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }
  
  function closeRankInfoModal() {
    const modal = document.getElementById('rankInfoModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  }
  
  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeRankInfoModal();
    }
  });
  
  // Update Donation Rank Visibility
  function updateDonationRankVisibility(isVisible) {
    fetch('{% url "manage_profile" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': window.csrfToken
      },
      body: new URLSearchParams({
        'action': 'update_rank_visibility',
        'show_donation_rank': isVisible
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const message = isVisible ? 'Donation rank badge is now visible' : 'Donation rank badge is now hidden';
        showNotification(message, 'success');
        
        // Optionally reload to show/hide badge
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        showNotification('Failed to update setting', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('An error occurred', 'error');
    });
  }
  
  // Simple notification function
  function showNotification(message, type) {
    // You can implement a toast notification here
    // For now, just use alert
    console.log(`${type}: ${message}`);
  }
</script>

<!-- Load utility modules -->
<script src="{% static 'js/modules/profile-tabs.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/profile-settings.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/settings.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/profile-forms.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/profile-modals.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/profile-upload.js' %}?v={{ STATIC_VERSION }}"></script>
<script src="{% static 'js/modules/profile-display-manager.js' %}?v={{ STATIC_VERSION }}"></script>
<!-- Load main manage profile application -->
<script src="{% static 'js/manage_profile_new.js' %}?v={{ STATIC_VERSION }}"></script>

<script>
// Philippine Address Cascading Dropdowns with Searchable Select
(function() {
    const regionSelect = document.getElementById('id_region');
    const provinceSelect = document.getElementById('id_province');
    const citySelect = document.getElementById('id_city_municipality');
    const barangaySelect = document.getElementById('id_barangay');
    
    let regionCodeMap = {};
    let provinceCodeMap = {};
    let cityCodeMap = {};
    
    // Initialize searchable select component
    function initSearchableSelect(wrapperId, selectId) {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper.querySelector('.searchable-select-input');
        const dropdown = wrapper.querySelector('.searchable-select-dropdown');
        const select = document.getElementById(selectId);
        
        // Toggle dropdown on input click
        input.addEventListener('click', function() {
            if (!this.disabled) {
                wrapper.classList.toggle('active');
            }
        });
        
        // Search functionality
        input.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const options = dropdown.querySelectorAll('.searchable-select-option');
            let hasVisible = false;
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.classList.remove('hidden');
                    hasVisible = true;
                } else {
                    option.classList.add('hidden');
                }
            });
            
            // Show "no results" message
            let noResults = dropdown.querySelector('.searchable-select-no-results');
            if (!hasVisible && options.length > 0) {
                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.className = 'searchable-select-no-results';
                    noResults.textContent = 'No results found';
                    dropdown.appendChild(noResults);
                }
            } else if (noResults) {
                noResults.remove();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!wrapper.contains(e.target)) {
                wrapper.classList.remove('active');
            }
        });
        
        return { wrapper, input, dropdown, select };
    }
    
    // Populate dropdown options
    function populateDropdown(wrapperId, selectId, options, codeMap) {
        const wrapper = document.getElementById(wrapperId);
        const input = wrapper.querySelector('.searchable-select-input');
        const dropdown = wrapper.querySelector('.searchable-select-dropdown');
        const select = document.getElementById(selectId);
        
        // Clear existing options
        dropdown.innerHTML = '';
        select.innerHTML = '<option value="">Select...</option>';
        
        // Clear and rebuild code map
        Object.keys(codeMap).forEach(key => delete codeMap[key]);
        
        // Add options
        options.forEach(option => {
            // Store code in map immediately
            codeMap[option.name] = option.code;
            
            // Add to hidden select (for form submission)
            const selectOption = document.createElement('option');
            selectOption.value = option.name;
            selectOption.textContent = option.name;
            selectOption.dataset.code = option.code;
            select.appendChild(selectOption);
            
            // Add to visible dropdown
            const dropdownOption = document.createElement('div');
            dropdownOption.className = 'searchable-select-option';
            dropdownOption.textContent = option.name;
            dropdownOption.dataset.value = option.name;
            dropdownOption.dataset.code = option.code;
            
            dropdownOption.addEventListener('click', function() {
                // Update input value
                input.value = this.textContent;
                
                // Update hidden select
                select.value = this.dataset.value;
                
                // Close dropdown
                wrapper.classList.remove('active');
                
                // Trigger change event
                select.dispatchEvent(new Event('change'));
                
                // Update selected state
                dropdown.querySelectorAll('.searchable-select-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
            
            dropdown.appendChild(dropdownOption);
        });
        
        // Enable the input
        input.disabled = false;
        input.placeholder = `Select or search...`;
        select.disabled = false;
    }
    
    // Initialize all searchable selects
    const regionComponent = initSearchableSelect('region-wrapper', 'id_region');
    const provinceComponent = initSearchableSelect('province-wrapper', 'id_province');
    const cityComponent = initSearchableSelect('city-wrapper', 'id_city_municipality');
    const barangayComponent = initSearchableSelect('barangay-wrapper', 'id_barangay');
    
    // Load regions on page load
    async function loadRegions() {
        try {
            const response = await fetch('/api/ph-regions/');
            const data = await response.json();
            
            if (data.success) {
                populateDropdown('region-wrapper', 'id_region', data.data, regionCodeMap);
                
                // Set saved value if exists
                const savedRegion = '{{ profile.region|escapejs }}';
                if (savedRegion && regionCodeMap[savedRegion]) {
                    regionComponent.input.value = savedRegion;
                    regionSelect.value = savedRegion;
                    await loadProvinces(regionCodeMap[savedRegion]);
                }
            }
        } catch (error) {
            console.error('Failed to load regions:', error);
        }
    }
    
    async function loadProvinces(regionCode) {
        if (!regionCode || regionCode === 'undefined') {
            console.error('Invalid region code:', regionCode);
            return;
        }
        
        try {
            provinceComponent.input.value = 'Loading...';
            provinceComponent.input.disabled = true;
            
            const response = await fetch(`/api/ph-provinces/?region_code=${regionCode}`);
            const data = await response.json();
            
            if (data.success) {
                populateDropdown('province-wrapper', 'id_province', data.data, provinceCodeMap);
                
                // Set saved value if exists
                const savedProvince = '{{ profile.province|escapejs }}';
                if (savedProvince && provinceCodeMap[savedProvince]) {
                    provinceComponent.input.value = savedProvince;
                    provinceSelect.value = savedProvince;
                    await loadCities(provinceCodeMap[savedProvince]);
                }
            }
        } catch (error) {
            console.error('Failed to load provinces:', error);
            provinceComponent.input.value = 'Error loading';
        }
    }
    
    async function loadCities(provinceCode) {
        if (!provinceCode || provinceCode === 'undefined') {
            console.error('Invalid province code:', provinceCode);
            return;
        }
        
        try {
            cityComponent.input.value = 'Loading...';
            cityComponent.input.disabled = true;
            
            const response = await fetch(`/api/ph-cities/?province_code=${provinceCode}`);
            const data = await response.json();
            
            if (data.success) {
                populateDropdown('city-wrapper', 'id_city_municipality', data.data, cityCodeMap);
                
                // Set saved value if exists
                const savedCity = '{{ profile.city_municipality|escapejs }}';
                if (savedCity && cityCodeMap[savedCity]) {
                    cityComponent.input.value = savedCity;
                    citySelect.value = savedCity;
                    await loadBarangays(cityCodeMap[savedCity]);
                }
            }
        } catch (error) {
            console.error('Failed to load cities:', error);
            cityComponent.input.value = 'Error loading';
        }
    }
    
    async function loadBarangays(cityCode) {
        if (!cityCode || cityCode === 'undefined') {
            console.error('Invalid city code:', cityCode);
            return;
        }
        
        try {
            barangayComponent.input.value = 'Loading...';
            barangayComponent.input.disabled = true;
            
            const response = await fetch(`/api/ph-barangays/?city_code=${cityCode}`);
            const data = await response.json();
            
            if (data.success) {
                populateDropdown('barangay-wrapper', 'id_barangay', data.data, {});
                
                // Set saved value if exists
                const savedBarangay = '{{ profile.barangay|escapejs }}';
                if (savedBarangay) {
                    barangayComponent.input.value = savedBarangay;
                    barangaySelect.value = savedBarangay;
                }
            }
        } catch (error) {
            console.error('Failed to load barangays:', error);
            barangayComponent.input.value = 'Error loading';
        }
    }
    
    // Event listeners for cascading
    regionSelect.addEventListener('change', function() {
        const regionCode = regionCodeMap[this.value];
        
        // Reset dependent dropdowns
        provinceComponent.input.value = '';
        provinceComponent.input.placeholder = 'Select province first...';
        provinceComponent.input.disabled = true;
        provinceComponent.dropdown.innerHTML = '';
        
        cityComponent.input.value = '';
        cityComponent.input.placeholder = 'Select city first...';
        cityComponent.input.disabled = true;
        cityComponent.dropdown.innerHTML = '';
        
        barangayComponent.input.value = '';
        barangayComponent.input.placeholder = 'Select barangay first...';
        barangayComponent.input.disabled = true;
        barangayComponent.dropdown.innerHTML = '';
        
        if (regionCode) {
            loadProvinces(regionCode);
        }
    });
    
    provinceSelect.addEventListener('change', function() {
        const provinceCode = provinceCodeMap[this.value];
        
        // Reset dependent dropdowns
        cityComponent.input.value = '';
        cityComponent.input.placeholder = 'Select city first...';
        cityComponent.input.disabled = true;
        cityComponent.dropdown.innerHTML = '';
        
        barangayComponent.input.value = '';
        barangayComponent.input.placeholder = 'Select barangay first...';
        barangayComponent.input.disabled = true;
        barangayComponent.dropdown.innerHTML = '';
        
        if (provinceCode) {
            loadCities(provinceCode);
        }
    });
    
    citySelect.addEventListener('change', function() {
        const cityCode = cityCodeMap[this.value];
        
        // Reset dependent dropdown
        barangayComponent.input.value = '';
        barangayComponent.input.placeholder = 'Select barangay first...';
        barangayComponent.input.disabled = true;
        barangayComponent.dropdown.innerHTML = '';
        
        if (cityCode) {
            loadBarangays(cityCode);
        }
    });
    
    // Postal code validation
    const postalCodeInput = document.getElementById('id_postal_code');
    postalCodeInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
    });
    
    // Set saved street address and postal code
    document.getElementById('id_street_address').value = '{{ profile.street_address|escapejs }}';
    document.getElementById('id_postal_code').value = '{{ profile.postal_code|escapejs }}';
    
    // Initialize on page load
    loadRegions();
})();

// Address is now displayed directly in the HTML template, no need for JavaScript injection

// Initialize profile system with error handling
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (window.ManageProfileSystem && !window.profileSystemInitialized) {
            const profileSystem = new window.ManageProfileSystem();
            if (profileSystem.init()) {
                window.profileSystemInitialized = true;
                console.log('Profile system initialized from template');
            }
        }
    } catch (error) {
        console.error('Profile system initialization failed:', error);
    }
    
    // Initialize settings navigation
    if (window.SettingsManager) {
        const settingsManager = new window.SettingsManager();
        settingsManager.init();
    }
    
    // Initialize activity sorting
    initializeActivitySorting();
    
    // Initialize analytics period filtering
    initializeAnalyticsPeriodFilter();
});

// Activity Sorting Functionality
function initializeActivitySorting() {
    const sortSelect = document.getElementById('activity-sort');
    const activityList = document.getElementById('activity-list');
    
    if (!sortSelect || !activityList) return;
    
    sortSelect.addEventListener('change', function() {
        const sortType = this.value;
        const activities = Array.from(activityList.querySelectorAll('.activity-item'));
        
        // Sort activities based on selected option
        activities.sort((a, b) => {
            if (sortType === 'newest') {
                // Already in newest first order by default
                const timeA = a.querySelector('.activity-meta').textContent;
                const timeB = b.querySelector('.activity-meta').textContent;
                return compareTimeAgo(timeA, timeB);
            } else if (sortType === 'oldest') {
                // Reverse order
                const timeA = a.querySelector('.activity-meta').textContent;
                const timeB = b.querySelector('.activity-meta').textContent;
                return compareTimeAgo(timeB, timeA);
            } else if (sortType === 'type') {
                // Sort by activity type (icon class)
                const typeA = getActivityType(a);
                const typeB = getActivityType(b);
                return typeA.localeCompare(typeB);
            }
            return 0;
        });
        
        // Clear and re-append sorted activities
        activityList.innerHTML = '';
        activities.forEach(activity => activityList.appendChild(activity));
    });
}

// Helper function to compare time ago strings
function compareTimeAgo(timeA, timeB) {
    const getMinutes = (timeStr) => {
        if (timeStr.includes('just now')) return 0;
        const match = timeStr.match(/(\d+)\s+(second|minute|hour|day|month|year)/);
        if (!match) return 0;
        
        const value = parseInt(match[1]);
        const unit = match[2];
        
        const multipliers = {
            'second': 1 / 60,
            'minute': 1,
            'hour': 60,
            'day': 1440,
            'month': 43200,
            'year': 525600
        };
        
        return value * (multipliers[unit] || 0);
    };
    
    return getMinutes(timeA) - getMinutes(timeB);
}

// Helper function to get activity type from icon
function getActivityType(activityItem) {
    const iconSvg = activityItem.querySelector('.activity-icon svg');
    const text = activityItem.querySelector('.activity-text').textContent.toLowerCase();
    
    if (text.includes('liked')) return 'like';
    if (text.includes('comment')) return 'comment';
    if (text.includes('bookmark') || text.includes('saved')) return 'bookmark';
    if (text.includes('follow')) return 'follow';
    if (text.includes('booking') || text.includes('booked')) return 'booking';
    
    return 'other';
}

// Analytics Period Filter Functionality
function initializeAnalyticsPeriodFilter() {
    const periodSelect = document.getElementById('analytics-period');
    const analyticsCards = document.querySelectorAll('.analytics-card');
    
    if (!periodSelect || analyticsCards.length === 0) return;
    
    periodSelect.addEventListener('change', function() {
        const period = this.value;
        
        analyticsCards.forEach(card => {
            const valueElement = card.querySelector('.analytics-value');
            const labelElement = card.querySelector('.analytics-label');
            const cardType = card.dataset.type;
            const newValue = card.dataset[period];
            
            // Add animation class
            card.classList.add('updating');
            
            setTimeout(() => {
                // Update the value
                if (cardType === 'donated') {
                    valueElement.textContent = '₱' + newValue;
                } else {
                    valueElement.textContent = newValue;
                }
                
                // Update label based on period
                const labelText = labelElement.textContent.replace(/\(.*?\)\s*/, '');
                let periodLabel = '';
                
                switch(period) {
                    case 'month':
                        periodLabel = '(Month) ';
                        break;
                    case 'week':
                        periodLabel = '(Week) ';
                        break;
                    case 'today':
                        periodLabel = '(Today) ';
                        break;
                    default:
                        periodLabel = '';
                }
                
                labelElement.textContent = periodLabel + labelText;
                
                // Remove animation class
                card.classList.remove('updating');
            }, 150);
        });
    });
}

// Add CSS animation for card updates
const style = document.createElement('style');
style.textContent = `
    .analytics-card.updating {
        opacity: 0.6;
        transform: scale(0.98);
    }
    
    .analytics-card {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
`;
document.head.appendChild(style);

// Handle show more/less functionality for saved posts
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('show-more-btn')) {
            const button = e.target;
            const postText = button.closest('.post-text');
            const savedPostItem = button.closest('.saved-post-item');
            const isExpanded = postText.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                postText.classList.remove('expanded');
                const truncatedText = postText.dataset.fullText.split(' ').slice(0, 15).join(' ');
                postText.innerHTML = truncatedText + (postText.dataset.fullText.split(' ').length > 15 ? '...' : '') + 
                                   '<button class="show-more-btn" type="button">Show more</button>';
                savedPostItem.style.maxHeight = '180px';
            } else {
                // Expand
                postText.classList.add('expanded');
                postText.innerHTML = postText.dataset.fullText + 
                                   '<button class="show-more-btn" type="button">Show less</button>';
                savedPostItem.style.maxHeight = 'none';
            }
        }
    });
});

// Activity Pagination - Load More
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreBtn = document.getElementById('load-more-activities');
    const activityContainer = document.getElementById('activity-list-container');
    const loadingSpinner = document.getElementById('activity-loading');
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            const offset = parseInt(this.dataset.offset);
            
            // Show loading, hide button
            loadMoreBtn.style.display = 'none';
            loadingSpinner.style.display = 'flex';
            
            // Fetch more activities
            fetch(`/accounts/api/load-more-activities/?offset=${offset}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.activities.length > 0) {
                    // Append new activities
                    data.activities.forEach(activity => {
                        const activityItem = createActivityItem(activity);
                        activityContainer.appendChild(activityItem);
                    });
                    
                    // Update offset
                    loadMoreBtn.dataset.offset = data.next_offset;
                    
                    // Show/hide button based on has_more
                    if (data.has_more) {
                        loadMoreBtn.style.display = 'flex';
                    } else {
                        // No more activities, show message
                        const endMessage = document.createElement('div');
                        endMessage.className = 'activity-end-message';
                        endMessage.textContent = 'No more activities to load';
                        endMessage.style.textAlign = 'center';
                        endMessage.style.padding = '1rem';
                        endMessage.style.color = 'var(--muted)';
                        document.querySelector('.activity-pagination').appendChild(endMessage);
                    }
                } else {
                    loadMoreBtn.style.display = 'none';
                }
                
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading activities:', error);
                loadMoreBtn.style.display = 'flex';
                loadingSpinner.style.display = 'none';
                alert('Failed to load more activities. Please try again.');
            });
        });
    }
    
    // Helper function to create activity item HTML
    function createActivityItem(activity) {
        const item = document.createElement('div');
        item.className = 'activity-item';
        
        // Add activity type class for styling
        if (activity.activity_type) {
            item.classList.add('activity-type-' + activity.activity_type);
        }
        
        const iconSvg = getActivityIcon(activity.icon_class);
        const timeAgo = formatTimeAgo(activity.time_ago);
        
        // Build details HTML if available
        let detailsHtml = '';
        if (activity.details) {
            detailsHtml = '<div class="activity-details">';
            if (activity.details.church_name) {
                detailsHtml += `<span class="activity-church">${activity.details.church_name}</span>`;
                if (activity.details.content_preview) {
                    detailsHtml += `<span class="activity-preview">${activity.details.content_preview}</span>`;
                }
            } else if (activity.details.name) {
                detailsHtml += `<span class="activity-item-name">${activity.details.name}</span>`;
                if (activity.details.description) {
                    detailsHtml += `<span class="activity-preview">${activity.details.description}</span>`;
                }
            }
            detailsHtml += '</div>';
        }
        
        item.innerHTML = `
            <div class="activity-icon activity-icon-${activity.activity_type || 'default'}">
                ${iconSvg}
            </div>
            <div class="activity-content">
                <div class="activity-text">${activity.description}</div>
                ${detailsHtml}
                <div class="activity-meta">${timeAgo}</div>
            </div>
        `;
        
        return item;
    }
    
    // Helper function to get activity icon SVG
    function getActivityIcon(iconClass) {
        const icons = {
            'heart': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
            'message-circle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
            'bookmark': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>',
            'eye': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
            'user-plus': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M16 11h4"/><path d="M18 9v4"/></svg>',
            'user-minus': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/><path d="M14 11h6"/></svg>',
            'calendar-plus': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M12 14h4"/><path d="M14 12v4"/></svg>',
            'edit': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>'
        };
        
        return icons[iconClass] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>';
    }
    
    // Helper function to format time ago
    function formatTimeAgo(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        const days = Math.floor(hours / 24);
        if (days < 30) return `${days} day${days > 1 ? 's' : ''} ago`;
        const months = Math.floor(days / 30);
        if (months < 12) return `${months} month${months > 1 ? 's' : ''} ago`;
        const years = Math.floor(months / 12);
        return `${years} year${years > 1 ? 's' : ''} ago`;
    }
});
</script>
{% endblock %}
